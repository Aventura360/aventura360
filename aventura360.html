<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aventura360 â€” Planificador de Viajes</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Mono&display=swap" rel="stylesheet">
<style>
:root {
  --bg:       #080c18;
  --s1:       #0f1524;
  --s2:       #161e30;
  --s3:       #1d2640;
  --border:   rgba(255,255,255,0.08);
  --border2:  rgba(255,255,255,0.14);
  --text:     #e8edf8;
  --text2:    #7a88a8;
  --text3:    #3d4d68;
  --blue:     #4f8ef7;
  --purple:   #7c5cfa;
  --green:    #10d48e;
  --yellow:   #f0b429;
  --red:      #f45b7a;
  --sky:      #38bdf8;
  --orange:   #fb923c;
  --r:        12px;
  --r2:       20px;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow-x:hidden}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);font-size:14px;line-height:1.5}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--s1)}
::-webkit-scrollbar-thumb{background:var(--s3);border-radius:3px}

/* â”€â”€ TOPBAR â”€â”€ */
@keyframes trailPulse{0%,100%{opacity:.55}50%{opacity:1}}
.topbar{height:76px;background:var(--s1);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:12px;position:sticky;top:0;z-index:100}
.logo-wrapper{position:relative;display:flex;flex-direction:column;align-items:center;width:310px;flex-shrink:0}
.logo-svg-layer{position:absolute;top:-18px;left:0;width:100%;height:70px;z-index:1;overflow:visible}
.logo-text-container{position:relative;z-index:2;text-align:center;display:flex;flex-direction:column;align-items:center;margin-top:18px}
.logo-main-title{display:flex;align-items:baseline;gap:0;line-height:1}
.txt-aventura{font-size:20px;font-weight:900;letter-spacing:1px;background:linear-gradient(90deg,#4f8ef7,#7c5cfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.txt-360{font-size:20px;font-weight:900;letter-spacing:1px;background:linear-gradient(90deg,#7c5cfa,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.logo-bottom-title{font-size:8.5px;font-weight:600;letter-spacing:3px;color:var(--text3);opacity:.6;text-transform:uppercase;line-height:1;margin-top:1px}
.logo-text-container{margin-top:14px}
.logo-main-title{line-height:1;margin-bottom:0}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:8px}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:var(--r);border:none;cursor:pointer;font-size:13px;font-weight:500;transition:all .15s;font-family:'Inter',sans-serif}
.btn:active{transform:scale(.97)}
.btn-primary{background:var(--blue);color:#fff}
.btn-primary:hover{background:#3d7ef5}
.btn-ghost{background:var(--s2);color:var(--text);border:1px solid var(--border)}
.btn-ghost:hover{background:var(--s3);border-color:var(--border2)}
.btn-danger{background:var(--red);color:#fff}
.btn-danger:hover{background:#e04070}
.btn-sm{padding:5px 11px;font-size:12px}
.btn-xs{padding:3px 8px;font-size:11px}
.btn-icon{padding:6px 8px;font-size:14px}

/* â”€â”€ CONTAINER â”€â”€ */
.container{max-width:1400px;margin:0 auto;padding:20px}

/* â”€â”€ TRIP BAR â”€â”€ */
.trip-bar{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:12px 16px;display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.trip-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text3);white-space:nowrap}
.trip-sel{flex:1;min-width:200px;background:var(--s2);border:1px solid var(--border);color:var(--text);padding:7px 12px;border-radius:8px;font-size:13px;font-family:'Inter',sans-serif;cursor:pointer}
.trip-sel:focus{outline:none;border-color:var(--blue)}

/* â”€â”€ NAV TABS â”€â”€ */
.nav-tabs{display:flex;gap:4px;background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:4px;margin-bottom:20px}
.nav-tab{flex:1;padding:10px 12px;border-radius:8px;border:none;background:transparent;color:var(--text2);font-size:14px;font-weight:500;cursor:pointer;transition:all .15s;text-align:center;font-family:'Inter',sans-serif}
.nav-tab:hover{color:var(--text);background:var(--s2)}
.nav-tab.active{background:var(--blue);color:#fff}

/* â”€â”€ STAT CARDS â”€â”€ */
.stats-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-bottom:20px}
@media(max-width:1100px){.stats-grid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:600px){.stats-grid{grid-template-columns:repeat(2,1fr)}}
.stat-card{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:16px;position:relative;overflow:hidden}
.stat-glow{position:absolute;width:70px;height:70px;border-radius:50%;top:-15px;right:-15px;opacity:.15;filter:blur(18px)}
.stat-icon{font-size:26px;margin-bottom:8px}
.stat-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:4px}
.stat-val{font-family:'Space Mono',monospace;font-size:22px;font-weight:700;line-height:1}
.stat-sub{font-size:11px;color:var(--text2);margin-top:4px}
.stat-bar{margin-top:8px;height:3px;background:var(--s3);border-radius:2px;overflow:hidden}
.stat-bar-fill{height:100%;border-radius:2px;transition:width .6s ease}

/* â”€â”€ CURRENCY BAR â”€â”€ */
.currency-bar{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:10px 16px;display:flex;align-items:center;gap:10px;margin-bottom:20px;flex-wrap:wrap}
.currency-bar label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text3);white-space:nowrap}
.chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--s2);color:var(--text2);transition:all .15s}
.chip:hover{border-color:var(--border2);color:var(--text)}
.chip.active{background:var(--blue);color:#fff;border-color:var(--blue)}
.rate-info{margin-left:auto;font-size:11px;color:var(--text3)}

/* â”€â”€ VIEW SECTIONS â”€â”€ */
.view{display:none}
.view.active{display:block}

/* â”€â”€ LAYOUT 2-COL â”€â”€ */
.layout2{display:grid;grid-template-columns:1fr 360px;gap:20px}
@media(max-width:1024px){.layout2{grid-template-columns:1fr}}

/* â”€â”€ PANEL â”€â”€ */
.panel{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);overflow:hidden}
.panel-header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.panel-title{font-size:15px;font-weight:600}
.panel-body{padding:18px}

/* â”€â”€ CATEGORY TABS â”€â”€ */
.cat-tabs{display:flex;gap:4px;flex-wrap:nowrap;overflow-x:auto;padding:12px 14px 0;background:var(--s1);scrollbar-width:none}
.cat-tabs::-webkit-scrollbar{display:none}
.cat-tab{flex-shrink:0;padding:6px 12px;border-radius:8px 8px 0 0;font-size:12px;font-weight:600;cursor:pointer;border:1px solid transparent;border-bottom:none;background:var(--s2);color:var(--text2);transition:all .15s;display:flex;align-items:center;gap:5px}
.cat-tab:hover{color:var(--text)}
.cat-tab.active{background:var(--s3);color:var(--text);border-color:var(--border)}
.cat-tab .cnt{background:rgba(255,255,255,.08);border-radius:10px;padding:1px 5px;font-size:10px}
.cat-tab.active .cnt{background:var(--blue);color:#fff}

/* â”€â”€ EXPENSE TABLE â”€â”€ */
.exp-table{width:100%;border-collapse:collapse;font-size:13px}
.exp-table th{padding:9px 14px;text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);border-bottom:1px solid var(--border);font-weight:700}
.exp-table td{padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.03);vertical-align:middle}
.exp-table tr:hover td{background:var(--s2)}
.exp-table tr:last-child td{border-bottom:none}
.cat-pill{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:6px;font-size:11px;font-weight:600}
.status-dot{display:inline-flex;align-items:center;gap:4px;font-size:11px}
.status-dot::before{content:'';width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0}
.status-pagado{color:var(--green)}
.status-reservado{color:var(--blue)}
.status-pendiente{color:var(--yellow)}
.status-cancelado{color:var(--text3)}
.mono{font-family:'Space Mono',monospace;font-size:12px}
.empty-state{text-align:center;padding:48px 20px;color:var(--text3)}
.empty-state .ei{font-size:40px;margin-bottom:12px;opacity:.4}

/* â”€â”€ FORM â”€â”€ */
.form-stack{display:flex;flex-direction:column;gap:12px}
.fgroup{display:flex;flex-direction:column;gap:5px}
.fgroup label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--text3)}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.inp{background:var(--s2);border:1px solid var(--border);color:var(--text);padding:9px 12px;border-radius:8px;font-size:14px;font-family:'Inter',sans-serif;width:100%;transition:border-color .15s}
.inp:focus{outline:none;border-color:var(--blue)}
.inp::placeholder{color:var(--text3)}
select.inp{cursor:pointer}
textarea.inp{min-height:72px;resize:vertical}
.convert-info{font-size:11px;color:var(--text2);background:var(--s2);border-radius:6px;padding:6px 10px;display:none}

/* â”€â”€ MODAL â”€â”€ */
.overlay{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.75);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;padding:20px}
.overlay.open{display:flex}
.modal{background:var(--s1);border:1px solid var(--border2);border-radius:var(--r2);padding:28px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto}
.modal h2{font-size:20px;font-weight:700;margin-bottom:20px}
.modal-footer{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;padding-top:16px;border-top:1px solid var(--border)}

/* â”€â”€ CONFIRM DIALOG â”€â”€ */
#dlgConfirm{z-index:600}
.confirm-box{background:var(--s1);border:1px solid var(--border2);border-radius:var(--r2);padding:28px;max-width:380px;width:100%;text-align:center}
.confirm-box .ci{font-size:32px;margin-bottom:12px}
.confirm-box p{color:var(--text2);font-size:14px;line-height:1.6;margin-bottom:22px}
.confirm-box .actions{display:flex;gap:10px;justify-content:center}

/* â”€â”€ TOAST â”€â”€ */
#toasts{position:fixed;bottom:24px;right:24px;z-index:1000;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{background:var(--s1);border:1px solid var(--border2);border-radius:10px;padding:10px 16px;font-size:13px;display:flex;align-items:center;gap:8px;transform:translateX(120%);transition:transform .3s;pointer-events:none;max-width:320px}
.toast.show{transform:translateX(0)}
.toast.success{border-left:3px solid var(--green)}
.toast.error{border-left:3px solid var(--red)}
.toast.info{border-left:3px solid var(--blue)}

/* â”€â”€ ITINERARY â”€â”€ */
.day-nav{display:flex;gap:8px;overflow-x:auto;padding:4px 0 12px;margin-bottom:4px;scrollbar-width:none}
.day-nav::-webkit-scrollbar{display:none}
.day-chip{flex-shrink:0;padding:10px 16px;border-radius:16px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--s1);color:var(--text2);transition:all .2s;white-space:nowrap;text-align:center;min-width:72px}
.day-chip .dc-num{font-size:16px;font-weight:700;display:block;line-height:1.2}
.day-chip .dc-date{font-size:10px;font-weight:400;opacity:.7;display:block;margin-top:1px}
.day-chip:hover{border-color:var(--blue);color:var(--text);background:var(--s2);transform:translateY(-2px)}
.day-chip.active{background:linear-gradient(135deg,var(--blue),var(--purple));color:#fff;border-color:transparent;transform:translateY(-3px);box-shadow:0 8px 24px rgba(79,142,247,.35)}
.itin-layout{display:grid;grid-template-columns:1fr 340px;gap:20px}
@media(max-width:1024px){.itin-layout{grid-template-columns:1fr}}

/* Timeline vertical line */
.timeline{position:relative;padding-left:0}
.timeline::before{content:'';position:absolute;left:28px;top:0;bottom:0;width:2px;background:linear-gradient(to bottom,var(--blue),var(--purple),transparent);opacity:.25;z-index:0}

/* Timeline items */
.tl-item{display:flex;gap:16px;padding:14px 16px 14px 0;position:relative;cursor:default;
  animation:tlFadeIn .4s ease both}
@keyframes tlFadeIn{from{opacity:0;transform:translateX(-16px)}to{opacity:1;transform:translateX(0)}}
.tl-item:nth-child(1){animation-delay:.05s}
.tl-item:nth-child(2){animation-delay:.1s}
.tl-item:nth-child(3){animation-delay:.15s}
.tl-item:nth-child(4){animation-delay:.2s}
.tl-item:nth-child(5){animation-delay:.25s}
.tl-item:nth-child(6){animation-delay:.3s}
.tl-item:nth-child(7){animation-delay:.35s}
.tl-item:nth-child(8){animation-delay:.4s}

.tl-connector{position:absolute;left:16px;top:0;bottom:-14px;width:2px;background:var(--border);z-index:0}
.tl-item:last-child .tl-connector{display:none}

.tl-dot-wrap{position:relative;z-index:1;flex-shrink:0}
.tl-dot{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;
  background:var(--s2);border:2px solid var(--border);
  transition:transform .2s,box-shadow .2s}
.tl-item:hover .tl-dot{transform:scale(1.1);box-shadow:0 4px 16px rgba(79,142,247,.3)}

/* Dot color by type */
.tl-dot.vuelo{background:rgba(79,142,247,.15);border-color:var(--blue)}
.tl-dot.alojamiento{background:rgba(240,180,41,.12);border-color:var(--yellow)}
.tl-dot.comida{background:rgba(251,146,60,.12);border-color:var(--orange)}
.tl-dot.transporte{background:rgba(16,212,142,.12);border-color:var(--green)}
.tl-dot.actividad{background:rgba(244,91,122,.12);border-color:var(--red)}
.tl-dot.visita{background:rgba(56,189,248,.12);border-color:var(--sky)}
.tl-dot.compras{background:rgba(124,92,250,.12);border-color:var(--purple)}
.tl-dot.entrada{background:rgba(251,146,60,.12);border-color:var(--orange)}

.tl-card{flex:1;background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;
  transition:border-color .2s,transform .2s,box-shadow .2s;min-width:0}
.tl-item:hover .tl-card{border-color:var(--border2);transform:translateX(4px);box-shadow:0 4px 20px rgba(0,0,0,.3)}

.tl-card-header{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:6px}
.tl-time{font-size:11px;color:var(--blue);font-family:'Space Mono',monospace;font-weight:700;white-space:nowrap}
.tl-status{font-size:10px;padding:2px 7px;border-radius:8px;font-weight:600;white-space:nowrap}
.tl-status.pendiente{background:rgba(240,180,41,.12);color:var(--yellow)}
.tl-status.reservado{background:rgba(79,142,247,.15);color:var(--blue)}
.tl-status.pagado{background:rgba(16,212,142,.15);color:var(--green)}
.tl-status.cancelado{background:rgba(244,91,122,.12);color:var(--red)}
.tl-title{font-size:15px;font-weight:700;margin-bottom:4px;line-height:1.3}
.tl-meta{font-size:12px;color:var(--text2);display:flex;gap:12px;flex-wrap:wrap}
.tl-meta span{display:flex;align-items:center;gap:3px}
.tl-cost{font-family:'Space Mono',monospace;font-size:11px;color:var(--green);font-weight:700}
.tl-actions{display:flex;gap:6px;flex-shrink:0;opacity:0;transition:opacity .2s}
.tl-item:hover .tl-actions{opacity:1}

/* Day header card */
.day-header-card{background:linear-gradient(135deg,rgba(79,142,247,.08),rgba(124,92,250,.06));border:1px solid rgba(79,142,247,.2);border-radius:var(--r);padding:14px 18px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
.day-header-num{font-size:28px;font-weight:800;background:linear-gradient(135deg,var(--blue),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1}
.day-header-date{font-size:13px;color:var(--text2);margin-top:2px}
.day-header-stats{display:flex;gap:16px}
.dhs{text-align:center}
.dhs .n{font-size:18px;font-weight:700;color:var(--text)}
.dhs .l{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px}

.act-form{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:18px}
.act-form-title{font-size:14px;font-weight:600;margin-bottom:14px;color:var(--text2)}

/* â”€â”€ CHARTS â”€â”€ */
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:768px){.charts-grid{grid-template-columns:1fr}}
.chart-card{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:18px}
.chart-title{font-size:13px;font-weight:600;margin-bottom:14px;color:var(--text2)}
.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.bar-label{width:90px;font-size:11px;color:var(--text2);flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.bar-track{flex:1;height:6px;background:var(--s3);border-radius:3px;overflow:hidden}
.bar-fill{height:100%;border-radius:3px;transition:width .6s ease}
.bar-val{width:70px;text-align:right;font-family:'Space Mono',monospace;font-size:11px;color:var(--text2);flex-shrink:0}

/* â”€â”€ BUDGET VS REAL â”€â”€ */
.bvr-row{display:flex;align-items:center;gap:14px;padding:12px 0;border-bottom:1px solid var(--border)}
.bvr-row:last-child{border-bottom:none}
.bvr-cat{width:110px;font-size:12px;font-weight:600;flex-shrink:0}
.bvr-bars{flex:1}
.bvr-bar-row{display:flex;align-items:center;gap:8px;margin-bottom:4px}
.bvr-bar-label{width:36px;font-size:10px;color:var(--text3)}
.bvr-track{flex:1;height:5px;background:var(--s3);border-radius:3px;overflow:hidden}
.bvr-fill{height:100%;border-radius:3px}
.bvr-val{width:80px;text-align:right;font-family:'Space Mono',monospace;font-size:11px;flex-shrink:0}

/* â”€â”€ SHARE MODAL â”€â”€ */
.share-opt{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--border);border-radius:var(--r);cursor:pointer;transition:border-color .15s}
.share-opt:hover{border-color:var(--border2);background:var(--s2)}
.share-icon{font-size:24px;width:40px;text-align:center}
.share-info .name{font-weight:600;font-size:13px}
.share-info .desc{font-size:11px;color:var(--text2);margin-top:2px}

/* â”€â”€ SHEETS CONFIG â”€â”€ */
.sheets-config{display:flex;flex-direction:column;gap:14px}
.collapsible-header{display:flex;align-items:center;justify-content:space-between;cursor:pointer;padding:10px 14px;background:var(--s2);border-radius:var(--r);font-size:13px;font-weight:600;user-select:none}
.collapsible-body{display:none;padding:12px 14px;background:var(--s2);border-radius:0 0 var(--r) var(--r);margin-top:-4px;font-size:12px;color:var(--text2);line-height:1.8}
.collapsible-body.open{display:block}
.code-snippet{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;font-family:'Space Mono',monospace;font-size:11px;color:var(--green);line-height:1.7;overflow-x:auto;margin-top:8px;white-space:pre}
.status-msg{padding:8px 12px;border-radius:8px;font-size:13px;display:none}
.status-msg.ok{background:rgba(16,212,142,.1);border:1px solid rgba(16,212,142,.3);color:var(--green);display:block}
.status-msg.err{background:rgba(244,91,122,.1);border:1px solid rgba(244,91,122,.3);color:var(--red);display:block}
.status-msg.loading{background:rgba(79,142,247,.1);border:1px solid rgba(79,142,247,.3);color:var(--blue);display:block}

/* â”€â”€ MOBILE LOGO (must be BEFORE media queries) â”€â”€ */
.logo-mobile{display:none;position:relative;align-items:center;flex-shrink:0;height:44px;width:155px;margin-right:auto}
.logo-mobile-plane{position:absolute;left:8px;top:4px;font-size:14px;transform:rotate(-35deg);filter:drop-shadow(0 0 5px rgba(79,142,247,.95));z-index:3}
.logo-mobile-globe{position:absolute;right:4px;bottom:1px;font-size:12px;filter:drop-shadow(0 0 5px rgba(124,92,250,.85));z-index:3}
.logo-mobile-text{position:relative;z-index:2;display:flex;align-items:baseline;padding-left:28px;padding-top:16px}
.logo-mobile-a{font-size:16px;font-weight:900;letter-spacing:.5px;background:linear-gradient(90deg,#4f8ef7,#7c5cfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1}
.logo-mobile-3{font-size:16px;font-weight:900;background:linear-gradient(90deg,#7c5cfa,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE â€” TABLET (â‰¤768px)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:768px){
  .charts-grid{grid-template-columns:1fr}
  .itin-layout{grid-template-columns:1fr}
  .layout2{grid-template-columns:1fr}
  .bvr-cat{width:80px;font-size:11px}
  .bvr-val{width:60px;font-size:10px}
  .modal{padding:20px}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE â€” MÃ“VIL (â‰¤600px)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:600px){

  /* Topbar */
  .topbar{height:52px;padding:0 10px;flex-wrap:nowrap;gap:6px}
  .logo-wrapper{display:none}       /* hide desktop logo */
  .logo-mobile{display:flex}        /* show mobile logo */
  .topbar-right{gap:4px;flex-wrap:nowrap;flex-shrink:0}
  .topbar-right .btn-sm{font-size:11px;padding:4px 9px;white-space:nowrap}
  #btnToggleAmounts{font-size:11px;padding:4px 9px}
  #connBadge{font-size:10px;padding:2px 6px}

  /* Container */
  .container{padding:10px}

  /* Trip bar */
  .trip-bar{padding:8px 10px;gap:6px}
  .trip-sel{font-size:13px;padding:6px 10px}
  .trip-label{display:none}

  /* Nav tabs: scrollable horizontal */
  .nav-tabs{gap:2px;padding:3px;overflow-x:auto;flex-wrap:nowrap;scrollbar-width:none;display:flex}
  .nav-tabs::-webkit-scrollbar{display:none}
  .nav-tab{flex-shrink:0;padding:6px 10px;font-size:11px;white-space:nowrap}

  /* Stats grid: 2 columnas */
  .stats-grid{grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
  .stat-card{padding:12px}
  .stat-icon{font-size:20px;margin-bottom:4px}
  .stat-val{font-size:18px}
  .stat-label{font-size:9px}

  /* Currency bar */
  .currency-bar{padding:8px 10px;gap:6px}
  .rate-info{display:none}

  /* Layout 2 col */
  .layout2{grid-template-columns:1fr}
  .frow{grid-template-columns:1fr}

  /* Expense table: card layout */
  .exp-table thead{display:none}
  .exp-table tr{display:block;border:1px solid var(--border);border-radius:var(--r);margin-bottom:8px;padding:10px 12px;background:var(--s1)}
  .exp-table td{display:flex;justify-content:space-between;align-items:center;padding:4px 0;border:none;font-size:12px}
  .exp-table td:first-child{font-weight:600;font-size:13px;border-bottom:1px solid var(--border);padding-bottom:8px;margin-bottom:4px}
  .exp-table td::before{content:attr(data-label);font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-right:8px}

  /* Cat tabs */
  .cat-tabs{padding:8px 10px 0;gap:3px}
  .cat-tab{padding:5px 9px;font-size:11px}

  /* Day nav chips */
  .day-chip{min-width:56px;padding:7px 10px}
  .day-chip .dc-num{font-size:14px}

  /* Day header */
  .day-header-card{padding:10px 12px;gap:6px}
  .day-header-num{font-size:22px}
  .day-header-date{font-size:11px}
  .dhs .n{font-size:15px}
  .day-header-card > div:last-child{width:100%;justify-content:flex-start}

  /* Timeline */
  .tl-item{gap:10px;padding:10px 8px 10px 0}
  .tl-dot{width:34px;height:34px;font-size:16px}
  .tl-card{padding:10px 12px}
  .tl-title{font-size:13px}
  .tl-actions{opacity:1} /* always visible on mobile */

  /* Act form */
  .act-form{padding:12px}
  /* form stays below timeline on mobile */

  /* Panels */
  .panel-body{padding:12px}
  .panel-header{padding:10px 14px}

  /* Charts */
  .chart-card{padding:12px}
  .bar-label{width:70px;font-size:10px}
  .bar-val{width:55px;font-size:10px}

  /* Budget vs real */
  .bvr-row{flex-wrap:wrap;gap:8px;padding:10px 0}
  .bvr-cat{width:100%;font-size:12px}
  .bvr-val{width:55px;font-size:10px}

  /* Modals */
  .overlay{padding:10px;align-items:flex-end}
  .modal{border-radius:16px 16px 0 0;max-height:85vh;padding:20px 16px}
  .modal h2{font-size:17px}

  /* Toasts */
  #toasts{bottom:16px;right:12px;left:12px}
  .toast{max-width:100%}

  /* Resumen timeline */
  .logo-wrapper{width:260px}

  /* Share opts */
  .share-opt{padding:10px}
  .share-icon{font-size:20px;width:32px}
}

/* â”€â”€ MOBILE BOTTOM NAV â”€â”€ */
.mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;z-index:200;background:var(--s1);border-top:1px solid var(--border);padding:4px 0 env(safe-area-inset-bottom,4px)}
.mnav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 4px;background:none;border:none;color:var(--text3);font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;cursor:pointer;transition:color .15s;font-family:'Inter',sans-serif}
.mnav-btn span:first-child{font-size:18px}
.mnav-btn.active{color:var(--blue)}

@media(max-width:600px){
  .mobile-nav{display:none} /* keep top tabs for now */
  .container{padding-bottom:16px}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE â€” MÃ“VIL PEQUEÃ‘O (â‰¤380px)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:380px){
  .nav-tab{font-size:10px;padding:5px 7px}
  .stat-val{font-size:15px}
  .txt-aventura{font-size:13px}
  .txt-360{font-size:13px}
  .topbar-right .btn-sm span, .topbar-right .btn-sm{font-size:9px;padding:2px 5px}
}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="logo-wrapper">
    <svg class="logo-svg-layer" viewBox="0 0 310 55" fill="none" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="pathGrad" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%"  stop-color="#4f8ef7" stop-opacity="1"/>
          <stop offset="100%" stop-color="#7c5cfa" stop-opacity="0.85"/>
        </linearGradient>
      </defs>
      <!-- Arco: empieza en x=55 (cerca del inicio del texto) y termina en x=255 (cerca del final) -->
      <path d="M 55 40 Q 155 8 255 40"
            stroke="url(#pathGrad)" stroke-width="1.3" fill="none"
            stroke-dasharray="2.5 3.5" stroke-linecap="round"
            style="animation:trailPulse 2.8s ease-in-out infinite"/>
      <path d="M 55 40 Q 80 30 102 37"
            stroke="#4f8ef7" stroke-width="0.9" fill="none"
            stroke-dasharray="2 3" stroke-linecap="round" opacity="0.45"/>
      <path d="M 55 40 Q 68 34 84 38"
            stroke="#4f8ef7" stroke-width="0.65" fill="none"
            stroke-dasharray="1.5 3" stroke-linecap="round" opacity="0.25"/>
    </svg>
    <!-- âœˆ pegado al inicio del texto AVENTURA -->
    <span style="position:absolute;left:32px;top:18px;font-size:16px;transform:rotate(-35deg);transform-origin:top right;filter:drop-shadow(0 0 5px rgba(79,142,247,.95));z-index:3">âœˆ</span>
    <!-- ğŸŒ + by Dio pegado al final del texto 360 -->
    <div style="position:absolute;right:4px;bottom:0;display:flex;flex-direction:column;align-items:center;z-index:3;gap:0">
      <span style="font-size:13px;filter:drop-shadow(0 0 5px rgba(124,92,250,.9));line-height:1">ğŸŒ</span>
      <span style="font-size:8px;font-style:italic;color:var(--text3);opacity:.6;line-height:1.2">by Dio</span>
    </div>
    <div class="logo-text-container">
      <div class="logo-main-title">
        <span class="txt-aventura">AVENTURA</span><span class="txt-360">360</span>
      </div>
      <div class="logo-bottom-title">Planificador de Viajes</div>
    </div>
  </div>
  <!-- LOGO MÃ“VIL (solo visible en mÃ³vil) -->
  <div class="logo-mobile">
    <svg viewBox="0 0 120 28" fill="none" xmlns="http://www.w3.org/2000/svg" style="position:absolute;top:0;left:0;width:120px;height:28px;overflow:visible">
      <defs>
        <linearGradient id="mgGrad" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="#4f8ef7"/>
          <stop offset="100%" stop-color="#7c5cfa" stop-opacity="0.85"/>
        </linearGradient>
      </defs>
      <path d="M 14 20 Q 62 2 110 20" stroke="url(#mgGrad)" stroke-width="1.2" fill="none" stroke-dasharray="2 3" stroke-linecap="round" style="animation:trailPulse 2.8s ease-in-out infinite"/>
    </svg>
    <span class="logo-mobile-plane">âœˆ</span>
    <div class="logo-mobile-text">
      <span class="logo-mobile-a">AVENTURA</span><span class="logo-mobile-3">360</span>
    </div>
    <span class="logo-mobile-globe">ğŸŒ</span>
  </div>

  <div class="topbar-right">
    <button class="btn btn-ghost btn-sm" id="btnToggleAmounts" onclick="App.toggleAmounts()" title="Mostrar/ocultar importes">ğŸ’° Importes</button>
    <span class="badge" id="connBadge" style="display:none"></span>
    <button class="btn btn-ghost btn-sm" onclick="Sheets.openConfig()" title="Conectar Google Sheets">ğŸ”—</button>
    <button class="btn btn-ghost btn-sm" id="btnSync" onclick="Sheets.sync()" style="display:none" title="Sincronizar con Sheets">â˜ï¸</button>
    <button class="btn btn-ghost btn-sm" onclick="App.hardRefresh()" title="Actualizar app">ğŸ”„</button>
    <button class="btn btn-primary btn-sm" onclick="Trips.openModal()">ï¼‹</button>
  </div>
</div>

<!-- MAIN -->
<div class="container">

  <!-- TRIP BAR -->
  <div class="trip-bar">
    <span class="trip-label">âœˆ Viaje</span>
    <select class="trip-sel" id="tripSel" onchange="App.selectTrip(this.value)">
      <option value="">â€” Selecciona un viaje â€”</option>
    </select>
    <button class="btn btn-ghost btn-sm" id="btnEditTrip" style="display:none" onclick="Trips.editCurrent()">âœ Editar</button>
    <button class="btn btn-danger btn-sm" id="btnDelTrip" style="display:none" onclick="Trips.deleteCurrent()">ğŸ—‘ Eliminar</button>
  </div>

  <!-- NAV TABS -->
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="App.switchTab('resumen',this)">ğŸ  Resumen</button>
    <button class="nav-tab" onclick="App.switchTab('itinerario',this)">ğŸ—“ Itinerario</button>
    <button class="nav-tab" onclick="App.switchTab('gastos',this)">ğŸ’¸ Gastos</button>
    <button class="nav-tab" onclick="App.switchTab('graficas',this)">ğŸ“Š GrÃ¡ficas</button>
    <button class="nav-tab" onclick="App.switchTab('presupuesto',this)">ğŸ¯ Pres. vs Real</button>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• VIEW: RESUMEN â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="view active" id="view-resumen">
    <div style="display:flex;justify-content:flex-end;margin-bottom:12px">
      <button class="btn btn-primary btn-sm" onclick="Share.openItinerary()">â†‘ Compartir</button>
    </div>
    <div id="resumenContent"></div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• VIEW: GASTOS â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="view" id="view-gastos">

    <!-- Stat cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-glow" style="background:var(--sky)"></div>
        <div class="stat-icon">ğŸ“…</div>
        <div class="stat-label">DÃ­as</div>
        <div class="stat-val" id="sDays">â€”</div>
        <div class="stat-sub" id="sDaysSub"></div>
      </div>
      <div class="stat-card">
        <div class="stat-glow" style="background:var(--purple)"></div>
        <div class="stat-icon">ğŸ§¾</div>
        <div class="stat-label">NÂº Gastos</div>
        <div class="stat-val" id="sItems">â€”</div>
        <div class="stat-sub" id="sItemsSub"></div>
      </div>
      <div class="stat-card">
        <div class="stat-glow" style="background:var(--blue)"></div>
        <div class="stat-icon">ğŸ’°</div>
        <div class="stat-label">Presupuesto</div>
        <div class="stat-val" id="sBudget">â€”</div>
        <div class="stat-bar"><div class="stat-bar-fill" id="sBudgetBar" style="background:var(--blue);width:0%"></div></div>
      </div>
      <div class="stat-card">
        <div class="stat-glow" style="background:var(--red)"></div>
        <div class="stat-icon">ğŸ’¸</div>
        <div class="stat-label">Total Gastado</div>
        <div class="stat-val" id="sSpent" style="color:var(--red)">â€”</div>
        <div class="stat-sub" id="sSpentPct"></div>
      </div>
      <div class="stat-card">
        <div class="stat-glow" style="background:var(--green)"></div>
        <div class="stat-icon">âœ…</div>
        <div class="stat-label">Disponible</div>
        <div class="stat-val" id="sAvail">â€”</div>
      </div>
      <div class="stat-card">
        <div class="stat-glow" style="background:var(--yellow)"></div>
        <div class="stat-icon">â³</div>
        <div class="stat-label">Pagado Real</div>
        <div class="stat-val" id="sPaid">â€”</div>
        <div class="stat-sub" id="sPaidSub"></div>
      </div>
    </div>

    <!-- Currency bar -->
    <div class="currency-bar">
      <label>Ver en:</label>
      <div class="chips" id="currencyChips"></div>
      <div class="rate-info" id="rateInfo">Tasas: â€”</div>
    </div>

    <!-- Expenses layout -->
    <div class="layout2">
      <!-- Left: list -->
      <div>
        <div class="cat-tabs" id="catTabs">
          <div class="cat-tab active" data-cat="todas" onclick="Expenses.filterCat('todas',this)">ğŸ—‚ Todas <span class="cnt" id="cnt-todas">0</span></div>
          <div class="cat-tab" data-cat="vuelos" onclick="Expenses.filterCat('vuelos',this)">âœˆï¸ Vuelos <span class="cnt" id="cnt-vuelos">0</span></div>
          <div class="cat-tab" data-cat="hoteles" onclick="Expenses.filterCat('hoteles',this)">ğŸ¨ Hoteles <span class="cnt" id="cnt-hoteles">0</span></div>
          <div class="cat-tab" data-cat="transfers" onclick="Expenses.filterCat('transfers',this)">ğŸš— Transfers <span class="cnt" id="cnt-transfers">0</span></div>
          <div class="cat-tab" data-cat="excursiones" onclick="Expenses.filterCat('excursiones',this)">ğŸ—ºï¸ Excurs. <span class="cnt" id="cnt-excursiones">0</span></div>
          <div class="cat-tab" data-cat="comidas" onclick="Expenses.filterCat('comidas',this)">ğŸ½ï¸ Comidas <span class="cnt" id="cnt-comidas">0</span></div>
          <div class="cat-tab" data-cat="seguros" onclick="Expenses.filterCat('seguros',this)">ğŸ›¡ï¸ Seguros <span class="cnt" id="cnt-seguros">0</span></div>
        </div>
        <div class="panel" style="border-radius:0 var(--r) var(--r) var(--r)">
          <div class="panel-header">
            <div class="panel-title" id="listTitle">Todos los Gastos</div>
            <div style="display:flex;gap:8px;align-items:center">
              <span id="listTotal" style="font-size:12px;color:var(--text2)"></span>
              <input class="inp" id="searchInp" placeholder="ğŸ” Buscarâ€¦" style="width:150px;padding:5px 10px;font-size:12px" oninput="Expenses.render()">
            </div>
          </div>
          <div id="expContainer"></div>
        </div>
      </div>

      <!-- Right: form -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title" id="expFormTitle">â• Nuevo Gasto</div>
          <button class="btn btn-ghost btn-xs" id="btnCancelEdit" style="display:none" onclick="Expenses.cancelEdit()">âœ• Cancelar</button>
        </div>
        <div class="panel-body">
          <div class="form-stack">
            <input type="hidden" id="fId">
            <div class="fgroup">
              <label>DescripciÃ³n *</label>
              <input class="inp" id="fDesc" placeholder="ej. Vuelo BCN â†’ NRT">
            </div>
            <div class="frow">
              <div class="fgroup">
                <label>CategorÃ­a</label>
                <select class="inp" id="fCat" onchange="Expenses.onCatChange()">
                  <option value="vuelos">âœˆï¸ Vuelos</option>
                  <option value="hoteles">ğŸ¨ Hoteles</option>
                  <option value="transfers">ğŸš— Transfers</option>
                  <option value="excursiones">ğŸ—ºï¸ Excursiones</option>
                  <option value="comidas">ğŸ½ï¸ Comidas</option>
                  <option value="seguros">ğŸ›¡ï¸ Seguros</option>
                </select>
              </div>
              <div class="fgroup">
                <label>Estado</label>
                <select class="inp" id="fEstado">
                  <option value="pendiente">â³ Pendiente</option>
                  <option value="reservado">ğŸ”µ Reservado</option>
                  <option value="pagado">âœ… Pagado</option>
                  <option value="cancelado">âŒ Cancelado</option>
                </select>
              </div>
            </div>
            <div class="frow">
              <div class="fgroup">
                <label>Importe *</label>
                <input class="inp" type="number" id="fAmount" placeholder="0.00" step="0.01" min="0" oninput="Expenses.updateConvert()">
              </div>
              <div class="fgroup">
                <label>Moneda</label>
                <select class="inp" id="fCur" onchange="Expenses.updateConvert()">
                  <option value="EUR">â‚¬ EUR</option>
                  <option value="USD">$ USD</option>
                  <option value="GBP">Â£ GBP</option>
                  <option value="JPY">Â¥ JPY</option>
                  <option value="MXN">MX$ MXN</option>
                  <option value="COP">COP</option>
                  <option value="CHF">CHF</option>
                  <option value="CAD">CA$ CAD</option>
                  <option value="AUD">AU$ AUD</option>
                  <option value="BRL">R$ BRL</option>
                  <option value="THB">à¸¿ THB</option>
                </select>
              </div>
            </div>
            <div id="convertInfo" class="convert-info"></div>
            <!-- Flight-specific fields (shown only for vuelos) -->
            <div id="flightFields" style="display:block;border:1px solid rgba(79,142,247,.3);border-radius:var(--r);padding:14px;background:var(--s2)">
              <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--blue);margin-bottom:10px">âœˆï¸ Datos de Vuelo</div>
              <div class="frow" style="margin-bottom:10px">
                <div class="fgroup">
                  <label>Fecha salida</label>
                  <input class="inp" type="date" id="fDepDate" oninput="Expenses._syncFlightDate()">
                </div>
                <div class="fgroup">
                  <label>Hora salida</label>
                  <input class="inp" type="time" id="fDepTime">
                </div>
              </div>
              <div class="frow">
                <div class="fgroup">
                  <label>Fecha llegada</label>
                  <input class="inp" type="date" id="fArrDate" oninput="Expenses._syncFlightDate()">
                </div>
                <div class="fgroup">
                  <label>Hora llegada</label>
                  <input class="inp" type="time" id="fArrTime">
                </div>
              </div>
              <div id="nextDayBadge" style="display:none;margin-top:8px;font-size:11px;color:var(--yellow);font-weight:600">âš ï¸ Llegada al dÃ­a siguiente</div>
            </div>

            <div id="normalDateRow" class="frow" style="display:none">
              <div class="fgroup">
                <label>Fecha</label>
                <input class="inp" type="date" id="fDate">
              </div>
              <div class="fgroup">
                <label>Proveedor</label>
                <input class="inp" id="fProvider" placeholder="ej. Iberia">
              </div>
            </div>
            <div class="fgroup">
              <label>Referencia / Localizador</label>
              <input class="inp" id="fRef" placeholder="ej. IB7742">
            </div>
            <div class="fgroup">
              <label>Notas</label>
              <textarea class="inp" id="fNotes" placeholder="Cualquier nota adicionalâ€¦"></textarea>
            </div>
            <button class="btn btn-primary" onclick="Expenses.save()" style="width:100%">
              <span id="btnSaveText">ğŸ’¾ Guardar Gasto</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• VIEW: ITINERARIO â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="view" id="view-itinerario">
    <div id="dayNav" class="day-nav"></div>
    <div class="itin-layout">
      <!-- Timeline -->
      <div>
        <div id="dayHeader" class="day-header-card" style="display:none">
          <div>
            <div class="day-header-num" id="dhTitle">DÃ­a 1</div>
            <div class="day-header-date" id="dhDate"></div>
          </div>
          <div class="day-header-stats">
            <div class="dhs"><div class="n" id="dhActs">0</div><div class="l">Actividades</div></div>
            <div class="dhs"><div class="n" id="dhCost">â€”</div><div class="l">Coste</div></div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-ghost btn-sm" onclick="Itin.prevDay()">â† Ant</button>
            <button class="btn btn-ghost btn-sm" onclick="Itin.nextDay()">Sig â†’</button>
            <button class="btn btn-ghost btn-sm" onclick="Share.openItinerary()">â†‘ Compartir</button>
          </div>
        </div>
        <div id="timeline">
          <div class="empty-state"><div class="ei">ğŸ—“</div><p>Selecciona un viaje con fechas para ver el itinerario dÃ­a a dÃ­a</p></div>
        </div>
      </div>
      <!-- Activity form -->
      <div class="act-form">
        <div class="act-form-title" id="actFormTitle">â• Nueva Actividad</div>
        <div class="form-stack">
          <input type="hidden" id="actId">
          <div class="fgroup">
            <label>TÃ­tulo *</label>
            <input class="inp" id="actTitle" placeholder="ej. Visita al Templo Senso-ji">
          </div>
          <div class="frow">
            <div class="fgroup">
              <label>Tipo</label>
              <select class="inp" id="actType" onchange="Itin.onTypeChange()">
                <option value="visita">ğŸ› Visita</option>
                <option value="entrada">ğŸŸ Entrada</option>
                <option value="actividad">ğŸ¯ Actividad</option>
                <option value="comida">ğŸ½ Comida</option>
                <option value="transporte">ğŸšŒ Transporte</option>
                <option value="alojamiento">ğŸ¨ Alojamiento</option>
                <option value="vuelo">âœˆï¸ Vuelo</option>
                <option value="compras">ğŸ› Compras</option>
                <option value="otro">ğŸ“Œ Otro</option>
              </select>
            </div>
            <div class="fgroup">
              <label>Estado</label>
              <select class="inp" id="actEstado">
                <option value="pendiente">â³ Pendiente</option>
                <option value="reservado">ğŸ”µ Reservado</option>
                <option value="pagado">âœ… Pagado</option>
                <option value="cancelado">âŒ Cancelado</option>
              </select>
            </div>
          </div>
          <!-- Normal time fields -->
          <div id="actNormalTimes" class="frow">
            <div class="fgroup">
              <label>Hora inicio</label>
              <input class="inp" type="time" id="actStart">
            </div>
            <div class="fgroup">
              <label>Hora fin</label>
              <input class="inp" type="time" id="actEnd">
            </div>
          </div>
          <!-- Flight-specific date+time fields -->
          <div id="actFlightFields" style="display:none;border:1px solid rgba(79,142,247,.3);border-radius:var(--r);padding:14px;background:var(--s2)">
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--blue);margin-bottom:10px">âœˆï¸ Datos de Vuelo</div>
            <div class="frow" style="margin-bottom:10px">
              <div class="fgroup">
                <label>Fecha salida</label>
                <input class="inp" type="date" id="actDepDate" oninput="Itin.syncFlightDate()">
              </div>
              <div class="fgroup">
                <label>Hora salida</label>
                <input class="inp" type="time" id="actDepTime">
              </div>
            </div>
            <div class="frow">
              <div class="fgroup">
                <label>Fecha llegada</label>
                <input class="inp" type="date" id="actArrDate" oninput="Itin.syncFlightDate()">
              </div>
              <div class="fgroup">
                <label>Hora llegada</label>
                <input class="inp" type="time" id="actArrTime">
              </div>
            </div>
            <div id="actNextDay" style="display:none;margin-top:8px;font-size:11px;color:var(--yellow);font-weight:600">âš ï¸ Llegada al dÃ­a siguiente</div>
          </div>
          <div class="fgroup">
            <label>Lugar</label>
            <input class="inp" id="actLugar" placeholder="ej. Asakusa, Tokio">
          </div>
          <div class="frow">
            <div class="fgroup">
              <label>Coste estimado</label>
              <input class="inp" type="number" id="actCoste" placeholder="0">
            </div>
            <div class="fgroup">
              <label>Referencia</label>
              <input class="inp" id="actRef" placeholder="NÂº reserva">
            </div>
          </div>
          <div class="fgroup">
            <label>URL</label>
            <input class="inp" id="actUrl" placeholder="https://â€¦">
          </div>
          <div class="fgroup">
            <label>Notas</label>
            <textarea class="inp" id="actNotes" style="min-height:60px"></textarea>
          </div>
          <button class="btn btn-primary" onclick="Itin.saveActivity()" style="width:100%">
            <span id="btnActText">ğŸ’¾ Guardar Actividad</span>
          </button>
          <button class="btn btn-ghost btn-sm" id="btnCancelAct" style="display:none;width:100%" onclick="Itin.cancelEdit()">âœ• Cancelar ediciÃ³n</button>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• VIEW: GRÃFICAS â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="view" id="view-graficas">
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-title">ğŸ“Š Gasto por CategorÃ­a</div>
        <div id="chartCat"></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">ğŸ”µ Estado de Gastos</div>
        <div id="chartStatus"></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">ğŸ“… Gasto por Fecha</div>
        <div id="chartDate"></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">ğŸ’± Por Moneda Original</div>
        <div id="chartCur"></div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• VIEW: PRESUPUESTO VS REAL â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="view" id="view-presupuesto">
    <div class="panel" style="margin-bottom:20px">
      <div class="panel-header">
        <div class="panel-title">ğŸ¯ Presupuesto por CategorÃ­a vs Gasto Real</div>
        <span style="font-size:11px;color:var(--text3)">Haz clic en el presupuesto para editar</span>
      </div>
      <div class="panel-body">
        <div id="bvrGrid"></div>
      </div>
    </div>
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-title">ğŸ“‰ Planificado vs Real</div>
        <div id="chartCompare"></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">ğŸ¯ % Presupuesto Utilizado</div>
        <div id="chartUtil"></div>
      </div>
    </div>
  </div>

</div><!-- /container -->

<!-- â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â• -->

<!-- TRIP MODAL -->
<div class="overlay" id="dlgTrip">
  <div class="modal">
    <h2 id="tripModalTitle">ğŸ—º Nuevo Viaje</h2>
    <div class="form-stack">
      <input type="hidden" id="tId">
      <div class="fgroup">
        <label>Nombre *</label>
        <input class="inp" id="tName" placeholder="ej. JapÃ³n Primavera 2026">
      </div>
      <div class="frow">
        <div class="fgroup">
          <label>Destino</label>
          <input class="inp" id="tDest" placeholder="ej. Tokio, Kioto">
        </div>
        <div class="fgroup">
          <label>Moneda Base</label>
          <select class="inp" id="tCur">
            <option value="EUR">â‚¬ EUR</option>
            <option value="USD">$ USD</option>
            <option value="GBP">Â£ GBP</option>
            <option value="JPY">Â¥ JPY</option>
            <option value="MXN">MX$ MXN</option>
            <option value="CHF">CHF</option>
          </select>
        </div>
      </div>
      <div class="frow">
        <div class="fgroup">
          <label>Fecha Inicio</label>
          <input class="inp" type="date" id="tStart">
        </div>
        <div class="fgroup">
          <label>Fecha Fin</label>
          <input class="inp" type="date" id="tEnd">
        </div>
      </div>
      <div class="fgroup">
        <label>Presupuesto Total</label>
        <input class="inp" type="number" id="tBudget" placeholder="0.00" min="0">
      </div>
      <div class="fgroup">
        <label>Notas</label>
        <textarea class="inp" id="tNotes" placeholder="DescripciÃ³n del viajeâ€¦"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="App.closeModal('dlgTrip')">Cancelar</button>
      <button class="btn btn-primary" onclick="Trips.save()">ğŸ’¾ Guardar Viaje</button>
    </div>
  </div>
</div>

<!-- SHEETS CONFIG MODAL -->
<div class="overlay" id="dlgSheets">
  <div class="modal" style="max-width:480px">
    <h2>ğŸ”— Conectar Google Sheets</h2>
    <div class="sheets-config">
      <p style="font-size:13px;color:var(--text2);margin-bottom:16px">Introduce la URL de tu Apps Script y la clave secreta que configuraste.</p>
      <div class="fgroup">
        <label>URL del Apps Script</label>
        <input class="inp" id="cfgScript" placeholder="https://script.google.com/macros/s/â€¦/exec">
      </div>
      <div class="fgroup" style="margin-top:10px">
        <label>Clave secreta</label>
        <input class="inp" type="password" id="cfgSecret" placeholder="Tu clave secreta">
      </div>
      <div id="sheetsStatus" class="status-msg" style="margin-top:12px"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="App.closeModal('dlgSheets')">Cancelar</button>
      <button class="btn btn-danger btn-sm" onclick="Sheets.disconnect()" id="btnDisconnect" style="display:none">Desconectar</button>
      <button class="btn btn-primary" onclick="Sheets.connect()">ğŸ”— Conectar y Verificar</button>
    </div>
  </div>
</div>

<!-- SHARE MODAL -->
<div class="overlay" id="dlgShare">
  <div class="modal" style="max-width:460px">
    <h2>â†‘ Compartir viaje</h2>
    <div style="display:flex;flex-direction:column;gap:10px" id="shareOptions"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="App.closeModal('dlgShare')">Cerrar</button>
    </div>
  </div>
</div>

<!-- CONFIRM DIALOG -->
<div class="overlay" id="dlgConfirm">
  <div class="confirm-box">
    <div class="ci">âš ï¸</div>
    <p id="confirmMsg">Â¿Confirmar acciÃ³n?</p>
    <div class="actions">
      <button class="btn btn-ghost" onclick="App._confirmResult(false)">Cancelar</button>
      <button class="btn btn-danger" onclick="App._confirmResult(true)">Confirmar</button>
    </div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div id="toasts"></div>

<!-- MOBILE BOTTOM NAV -->
<nav class="mobile-nav" id="mobileNav">
  <button class="mnav-btn active" onclick="App.switchTabMobile('resumen',this)">
    <span>ğŸ </span><span>Resumen</span>
  </button>
  <button class="mnav-btn" onclick="App.switchTabMobile('itinerario',this)">
    <span>ğŸ—“</span><span>Itinerario</span>
  </button>
  <button class="mnav-btn" onclick="App.switchTabMobile('gastos',this)">
    <span>ğŸ’¸</span><span>Gastos</span>
  </button>
  <button class="mnav-btn" onclick="App.switchTabMobile('graficas',this)">
    <span>ğŸ“Š</span><span>GrÃ¡ficas</span>
  </button>
  <button class="mnav-btn" onclick="App.switchTabMobile('presupuesto',this)">
    <span>ğŸ¯</span><span>Pres.</span>
  </button>
</nav>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AVENTURA360 â€” Complete rewrite
// Architecture: namespaced modules (App, Trips, Expenses, Itin,
//               Charts, Sheets, Share) communicating via shared State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ Formato numÃ©rico garantizado con punto de miles â”€â”€
function fmtNum(n) {
  // If n is already a JS number, use it directly.
  // If string, strip thousands dots only if they're grouping separators
  // (i.e. digits on both sides and not a decimal dot)
  let num;
  if (typeof n === 'number') {
    num = n;
  } else {
    // Remove grouping dots: a dot surrounded by digits â†’ thousands separator
    const clean = String(n).replace(/(\d)\.(\d{3})(?!\d)/g, '$1$2').replace(',', '.');
    num = parseFloat(clean);
  }
  const rounded = Math.round(isNaN(num) ? 0 : num);
  return rounded.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

const State = {
  tripId: null,
  catFilter: 'todas',
  displayCur: 'EUR',
  showAmounts: true,
  currentDay: null,
  rates: { EUR: 1, USD: 1.08, GBP: 0.86, JPY: 162, MXN: 18.5, COP: 4300, CHF: 0.96, CAD: 1.47, AUD: 1.65, BRL: 5.4, THB: 38.5 },
  ratesLoaded: false,
};

// â”€â”€ DB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DB = {
  trips: [],
  expenses: [],
  activities: [],
};

// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CFG = {
  key: '', sheetId: '', scriptUrl: '', secret: '',
  load() {
    try { const c = JSON.parse((typeof localStorage!=='undefined' && localStorage.getItem('a360_cfg')) || '{}'); Object.assign(this, c); } catch(e) {}
  },
  save() {
    try { localStorage.setItem('a360_cfg', JSON.stringify({ key: this.key, sheetId: this.sheetId, scriptUrl: this.scriptUrl, secret: this.secret })); } catch(e) {}
  },
};

// â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CATS = {
  vuelos:      { icon: 'âœˆï¸',  label: 'Vuelos',      color: 'var(--blue)' },
  hoteles:     { icon: 'ğŸ¨',  label: 'Hoteles',     color: 'var(--yellow)' },
  transfers:   { icon: 'ğŸš—',  label: 'Transfers',   color: 'var(--green)' },
  excursiones: { icon: 'ğŸ—ºï¸', label: 'Excursiones', color: 'var(--red)' },
  comidas:     { icon: 'ğŸ½ï¸', label: 'Comidas',     color: 'var(--orange)' },
  seguros:     { icon: 'ğŸ›¡ï¸', label: 'Seguros',     color: 'var(--purple)' },
};

const ACT_ICONS = {
  visita:'ğŸ›', entrada:'ğŸŸ', actividad:'ğŸ¯', comida:'ğŸ½',
  transporte:'ğŸšŒ', alojamiento:'ğŸ¨', vuelo:'âœˆï¸', compras:'ğŸ›', otro:'ğŸ“Œ',
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP â€” core utilities
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const App = {

  async init() {
    CFG.load();
    this.loadDB();

    // Restore Sheets badge if previously connected
    if (CFG.scriptUrl && CFG.secret) {
      Sheets._setBadge(true);
      // Auto-load from Sheets on startup
      try {
        const r = await Sheets.call({ action: 'loadAll', secret: CFG.secret });
        if (!r.error && r.trips && r.trips.length > 0) {
          Sheets._importFromSheets(r);
        }
      } catch(e) { /* offline â€” use local data */ }
    } else if (DB.trips.length === 0) {
      Demo.load();
      this.saveDB();
    }

    document.getElementById('fDate').value = new Date().toISOString().slice(0, 10);
    Rates.fetch();
    this.render();
    setTimeout(() => Expenses.onCatChange(), 0);
  },

  loadDB() {
    try { DB.trips      = JSON.parse((typeof localStorage!=='undefined' && localStorage.getItem('a360_trips'))      || '[]'); } catch(e) { DB.trips = []; }
    try { DB.expenses   = JSON.parse((typeof localStorage!=='undefined' && localStorage.getItem('a360_expenses'))   || '[]'); } catch(e) { DB.expenses = []; }
    try { DB.activities = JSON.parse((typeof localStorage!=='undefined' && localStorage.getItem('a360_activities')) || '[]'); } catch(e) { DB.activities = []; }
  },

  saveDB() {
    try { localStorage.setItem('a360_trips',      JSON.stringify(DB.trips)); } catch(e) {}
    try { localStorage.setItem('a360_expenses',   JSON.stringify(DB.expenses)); } catch(e) {}
    try { localStorage.setItem('a360_activities', JSON.stringify(DB.activities)); } catch(e) {}
    // Auto-push to Sheets if connected
    if (CFG.scriptUrl && CFG.secret) {
      Sheets.pushToSheets().catch(() => {}); // fire & forget
    }
  },

  render() {
    this.renderTripSelect();
    this.renderStats();
    this.renderCurrencyChips();
    Expenses.renderBadges();
    Expenses.render();
    Itin.render();
    this.renderResumen();
    // Always keep charts fresh
    Charts.render();
    Charts.renderBudget();
  },

  renderTripSelect() {
    const sel = document.getElementById('tripSel');
    const cur = State.tripId;
    sel.innerHTML = '<option value="">â€” Selecciona un viaje â€”</option>';
    DB.trips.forEach(t => {
      const o = document.createElement('option');
      o.value = t.id;
      o.textContent = t.nombre + (t.destino ? ' â€” ' + t.destino : '');
      if (t.id === cur) o.selected = true;
      sel.appendChild(o);
    });
    const has = !!State.tripId;
    document.getElementById('btnEditTrip').style.display = has ? '' : 'none';
    document.getElementById('btnDelTrip').style.display  = has ? '' : 'none';
  },

  selectTrip(id) {
    State.tripId = id || null;
    State.catFilter = 'todas';
    State.currentDay = null;
    this.render();
  },

  currentTrip() {
    return DB.trips.find(t => t.id === State.tripId) || null;
  },

  switchTabMobile(name, el) {
    // Sync top tabs
    const topTab = document.querySelector(`.nav-tab[onclick*="'${name}'"]`);
    if (topTab) this.switchTab(name, topTab);
    // Update bottom nav
    document.querySelectorAll('.mnav-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
  },

  switchTab(name, el) {
    document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('view-' + name).classList.add('active');
    if (name === 'graficas')     Charts.render();
    if (name === 'presupuesto')  Charts.renderBudget();
    if (name === 'resumen')      App.renderResumen();
  },

  renderResumen() {
    const t = this.currentTrip();
    const el = document.getElementById('resumenContent');
    if (!t) {
      el.innerHTML = '<div class="empty-state"><div class="ei">ğŸ </div><p>Selecciona un viaje para ver el resumen</p></div>';
      return;
    }

    const days = Itin.getDays(t);
    const acts = DB.activities.filter(a => a.viaje_id === t.id);
    const exps = DB.expenses.filter(e => e.viaje_id === t.id && e.estado !== 'cancelado');
    const moneda = t.moneda || 'EUR';

    // Budget stats
    const totalGasto = exps.reduce((s,e) => s + (e.importe_base||0), 0);
    const budget = t.presupuesto || 0;
    const pct = budget > 0 ? Math.min(totalGasto/budget*100,100).toFixed(1) : 0;

    // Days
    let totalDias = 'â€”';
    if (t.fecha_inicio && t.fecha_fin) {
      const d1 = new Date(t.fecha_inicio), d2 = new Date(t.fecha_fin);
      totalDias = Math.round((d2-d1)/864e5)+1;
    }

    // Day colors cycling
    const dayColors = ['#4f8ef7','#7c5cfa','#10d48e','#f0b429','#f45b7a','#38bdf8','#fb923c'];

    // Build timeline rows
    const timelineRows = days.map((d, i) => {
      const dayActs = acts.filter(a => a.fecha === d).sort((a,b) => (a.hora_inicio||'').localeCompare(b.hora_inicio||''));
      const dayCost = dayActs.reduce((s,a) => s+(a.coste||0), 0);
      const dt = new Date(d + 'T12:00:00');
      const dateStr = dt.toLocaleDateString('es-ES', { weekday:'short', day:'numeric', month:'short' });
      const color = dayColors[i % dayColors.length];

      // Location pill: first activity with a location, or first activity title
      const savedLabel = (t.dayLabels && t.dayLabels[d]) || '';
      const locAct = dayActs.find(a => a.lugar) || dayActs[0];
      const autoLabel = locAct ? (locAct.lugar || locAct.titulo) : '';
      const locLabel = savedLabel || autoLabel;
      const cityPill = `<div style="display:inline-flex;align-items:center;gap:6px;border:1.5px dashed ${locLabel ? color : 'var(--text3)'};border-radius:20px;padding:5px 14px;font-size:13px;font-weight:600;color:${locLabel ? color : 'var(--text3)'};cursor:pointer;max-width:220px" 
           onclick="App.editDayLabel('${d}','${t.id}',this)" title="Haz clic para editar">
           ğŸ“ ${locLabel || '<em style=\'font-weight:400;font-style:italic\'>AÃ±adir ciudad...</em>'}
         </div>`;

      const connector = i < days.length - 1
        ? `<div style="display:flex;justify-content:center;padding:4px 0">
             <div style="width:2px;height:32px;background:repeating-linear-gradient(to bottom,var(--text3) 0,var(--text3) 4px,transparent 4px,transparent 8px)"></div>
           </div>`
        : '';

      return `
        <div style="display:grid;grid-template-columns:130px 56px 1fr;align-items:center;gap:0;min-height:60px">
          <!-- Izquierda: DÃ­a N, fecha, coste -->
          <div style="text-align:right;padding-right:16px">
            <div style="font-size:22px;font-weight:800;color:${color}">DÃ­a ${i+1}</div>
            <div style="font-size:11px;color:var(--text2);margin-top:1px">${dateStr}</div>
            ${dayCost > 0 && State.showAmounts ? `<div style="font-size:11px;color:var(--green);margin-top:3px;display:flex;align-items:center;gap:3px;justify-content:flex-end"><span style="font-size:9px">ğŸ’¶</span> ${dayCost.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.')} ${moneda}</div>` : ''}
          </div>
          <!-- Centro: cÃ­rculo numerado -->
          <div style="display:flex;flex-direction:column;align-items:center">
            <div style="width:44px;height:44px;border-radius:50%;border:2.5px solid ${color};display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:800;color:${color};background:var(--bg);flex-shrink:0">${i+1}</div>
            <div style="font-size:14px;color:var(--text3);margin-top:4px">â†</div>
          </div>
          <!-- Derecha: ciudad pill + actividades -->
          <div style="padding-left:16px">
            ${cityPill}
            <div style="font-size:12px;color:var(--text2);margin-top:6px">${dayActs.length} actividad${dayActs.length!==1?'es':''}</div>
          </div>
        </div>
        ${connector}`;
    }).join('');

    el.innerHTML = `
      <!-- Tarjeta cabecera viaje -->
      <div style="background:var(--s1);border:1px solid var(--border);border-radius:16px;padding:20px 24px;margin-bottom:28px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px">
        <div>
          <div style="font-size:22px;font-weight:800;color:var(--text);margin-bottom:6px">${t.nombre}</div>
          <div style="font-size:13px;color:var(--text2);display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            ${t.destino ? `<span>ğŸ“ ${t.destino}</span>` : ''}
            ${t.fecha_inicio ? `<span>ğŸ“… ${t.fecha_inicio} â†’ ${t.fecha_fin}</span>` : ''}
          </div>
        </div>
        <div style="display:flex;gap:32px;align-items:center">
          <div style="text-align:center">
            <div style="font-size:36px;font-weight:900;color:var(--blue);font-family:'Space Mono',monospace;line-height:1">${totalDias}</div>
            <div style="font-size:10px;font-weight:700;letter-spacing:1px;color:var(--text3);margin-top:2px">DÃAS</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:36px;font-weight:900;color:var(--green);font-family:'Space Mono',monospace;line-height:1">${acts.length}</div>
            <div style="font-size:10px;font-weight:700;letter-spacing:1px;color:var(--text3);margin-top:2px">ACTIVIDADES</div>
          </div>
          ${State.showAmounts ? `<div style="text-align:center"><div style="font-size:36px;font-weight:900;color:var(--yellow);font-family:'Space Mono',monospace;line-height:1">${budget.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.')}</div><div style="font-size:10px;font-weight:700;letter-spacing:1px;color:var(--text3);margin-top:2px">${moneda}</div></div>` : ''}
        </div>
      </div>
      <!-- Timeline -->
      <div style="max-width:620px;margin:0 auto">
        ${timelineRows}
      </div>`;
  },

  renderStats() {
    const t = this.currentTrip();
    const ids = ['sBudget','sSpent','sAvail','sPaid','sDays','sItems','sSpentPct','sPaidSub','sDaysSub'];
    if (!t) {
      ['sBudget','sSpent','sAvail','sPaid','sDays','sItems'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = 'â€”';
      });
      document.getElementById('sBudgetBar').style.width = '0%';
      return;
    }

    const exps = DB.expenses.filter(e => e.viaje_id === t.id && e.estado !== 'cancelado');
    const paid = DB.expenses.filter(e => e.viaje_id === t.id && e.estado === 'pagado');
    const all  = DB.expenses.filter(e => e.viaje_id === t.id);

    const toDisplay = (amt, cur) => {
      const eur = amt / (State.rates[cur] || 1);
      return eur * (State.rates[State.displayCur] || 1);
    };

    const spent  = exps.reduce((s, e) => s + toDisplay(e.importe, e.moneda), 0);
    const paidAmt= paid.reduce((s, e) => s + toDisplay(e.importe, e.moneda), 0);
    const budgEUR= (t.presupuesto || 0) / (State.rates[t.moneda] || 1);
    const budget = budgEUR * (State.rates[State.displayCur] || 1);
    const avail  = budget - spent;
    const pct    = budget > 0 ? Math.min(spent / budget * 100, 100) : 0;

    const fmt = n => {
      const sym = { EUR:'â‚¬', USD:'$', GBP:'Â£', JPY:'Â¥', MXN:'MX$', CHF:'Fr', CAD:'C$', AUD:'A$', BRL:'R$', THB:'à¸¿', COP:'COP' };
      const s = (sym[State.displayCur] || '') + fmtNum(n);
      return s;
    };

    const sa = State.showAmounts;
    document.getElementById('sBudget').textContent   = sa ? fmt(budget) : 'Â·Â·Â·';
    document.getElementById('sSpent').textContent    = sa ? fmt(spent) : 'Â·Â·Â·';
    document.getElementById('sSpentPct').textContent = sa && budget > 0 ? (spent/budget*100).toFixed(1) + '% del pres.' : '';
    document.getElementById('sAvail').textContent    = sa ? (avail < 0 ? 'âˆ’' : '') + fmt(Math.abs(avail)) : 'Â·Â·Â·';
    document.getElementById('sAvail').style.color    = avail < 0 ? 'var(--red)' : 'var(--green)';
    document.getElementById('sPaid').textContent     = sa ? fmt(paidAmt) : 'Â·Â·Â·';
    document.getElementById('sPaidSub').textContent  = paid.length + ' pagados';
    document.getElementById('sItems').textContent    = all.length;
    document.getElementById('sItemsSub').textContent = exps.length + ' activos';

    const bar = document.getElementById('sBudgetBar');
    bar.style.width = pct + '%';
    bar.style.background = pct > 90 ? 'var(--red)' : pct > 70 ? 'var(--yellow)' : 'var(--blue)';

    if (t.fecha_inicio && t.fecha_fin) {
      const d1 = new Date(t.fecha_inicio), d2 = new Date(t.fecha_fin);
      const total = Math.round((d2 - d1) / 864e5) + 1;
      const rem   = Math.round((d2 - new Date()) / 864e5);
      document.getElementById('sDays').textContent    = total;
      document.getElementById('sDaysSub').textContent = rem > 0 ? rem + ' dÃ­as restantes' : rem === 0 ? 'Hoy termina' : 'Completado';
    } else {
      document.getElementById('sDays').textContent    = 'â€”';
      document.getElementById('sDaysSub').textContent = '';
    }
  },

  renderCurrencyChips() {
    const t = this.currentTrip();
    const used = new Set(['EUR']);
    if (t) used.add(t.moneda);
    DB.expenses.filter(e => e.viaje_id === State.tripId).forEach(e => used.add(e.moneda));
    const el = document.getElementById('currencyChips');
    el.innerHTML = '';
    used.forEach(c => {
      const chip = document.createElement('div');
      chip.className = 'chip' + (c === State.displayCur ? ' active' : '');
      chip.textContent = c;
      chip.onclick = () => { State.displayCur = c; this.render(); };
      el.appendChild(chip);
    });
  },

  openModal(id) {
    document.getElementById(id).classList.add('open');
  },

  closeModal(id) {
    document.getElementById(id).classList.remove('open');
    const st = document.getElementById('sheetsStatus');
    if (st) { st.className = 'status-msg'; st.textContent = ''; }
  },

  toggleCollapse(header) {
    const body = header.nextElementSibling;
    body.classList.toggle('open');
    header.querySelector('span').textContent = body.classList.contains('open') ? 'â–²' : 'â–¼';
  },

  // Confirm dialog (iframe-safe, no window.confirm)
  _confirmResolve: null,
  confirm(msg) {
    return new Promise(resolve => {
      this._confirmResolve = resolve;
      document.getElementById('confirmMsg').textContent = msg;
      document.getElementById('dlgConfirm').classList.add('open');
    });
  },
  _confirmResult(val) {
    document.getElementById('dlgConfirm').classList.remove('open');
    if (this._confirmResolve) { this._confirmResolve(val); this._confirmResolve = null; }
  },

  toast(msg, type = 'info') {
    const el = document.createElement('div');
    el.className = 'toast ' + type;
    el.innerHTML = (type === 'success' ? 'âœ“ ' : type === 'error' ? 'âœ— ' : 'â„¹ ') + msg;
    document.getElementById('toasts').appendChild(el);
    requestAnimationFrame(() => el.classList.add('show'));
    setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 350); }, 3000);
  },

  esc(s) {
    return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  },

  loadDemo() {
    Demo.load();
    this.saveDB();
    this.render();
    this.toast('Datos de ejemplo cargados âœ“', 'success');
  },

  editDayLabel(date, tripId, el) {
    const t = DB.trips.find(x => x.id === tripId);
    if (!t) return;
    if (!t.dayLabels) t.dayLabels = {};
    const current = t.dayLabels[date] || '';
    const input = document.createElement('input');
    input.value = current;
    input.placeholder = 'Ej: Tokio, Kioto...';
    input.style.cssText = 'background:var(--s2);border:1px solid var(--blue);color:var(--text);padding:4px 10px;border-radius:20px;font-size:13px;width:160px;outline:none;font-family:Inter,sans-serif';
    el.replaceWith(input);
    input.focus();
    input.select();
    const save = () => {
      t.dayLabels[date] = input.value.trim();
      App.saveDB();
      App.renderResumen();
      App.render();
    };
    input.addEventListener('blur', save);
    input.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); save(); } });
  },

  hardRefresh() {
    // Force reload bypassing cache
    window.location.reload(true);
  },

  toggleAmounts() {
    State.showAmounts = !State.showAmounts;
    const btn = document.getElementById('btnToggleAmounts');
    btn.textContent = State.showAmounts ? 'ğŸ’° Importes' : 'ğŸ™ˆ Ocultos';
    btn.style.color = State.showAmounts ? '' : 'var(--text3)';
    this.render();
    Charts.render();
    Charts.renderBudget();
  },

  resetAndDemo() {
    try { localStorage.removeItem('a360_trips'); } catch(e) {}
    try { localStorage.removeItem('a360_expenses'); } catch(e) {}
    try { localStorage.removeItem('a360_activities'); } catch(e) {}
    Demo.load();
    this.saveDB();
    this.render();
    this.toast('App reiniciada con datos demo âœ“', 'success');
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRIPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Trips = {

  openModal(trip) {
    const isEdit = !!trip;
    document.getElementById('tripModalTitle').textContent = isEdit ? 'âœï¸ Editar Viaje' : 'ğŸ—º Nuevo Viaje';
    document.getElementById('tId').value      = trip ? trip.id    : '';
    document.getElementById('tName').value    = trip ? trip.nombre  : '';
    document.getElementById('tDest').value    = trip ? (trip.destino || '') : '';
    document.getElementById('tCur').value     = trip ? (trip.moneda || 'EUR') : 'EUR';
    document.getElementById('tStart').value   = trip ? (trip.fecha_inicio || '') : '';
    document.getElementById('tEnd').value     = trip ? (trip.fecha_fin || '') : '';
    document.getElementById('tBudget').value  = trip ? (trip.presupuesto || '') : '';
    document.getElementById('tNotes').value   = trip ? (trip.notas || '') : '';
    App.openModal('dlgTrip');
  },

  save() {
    const name = document.getElementById('tName').value.trim();
    if (!name) { App.toast('El nombre es obligatorio', 'error'); return; }
    const editId = document.getElementById('tId').value;
    const id = editId || 'T' + Date.now();
    const obj = {
      id, nombre: name,
      destino:       document.getElementById('tDest').value.trim(),
      moneda:        document.getElementById('tCur').value,
      fecha_inicio:  document.getElementById('tStart').value,
      fecha_fin:     document.getElementById('tEnd').value,
      presupuesto:   parseFloat(document.getElementById('tBudget').value) || 0,
      notas:         document.getElementById('tNotes').value.trim(),
      pres_vuelos: 0, pres_hoteles: 0, pres_transfers: 0,
      pres_excursiones: 0, pres_comidas: 0, pres_seguros: 0,
    };
    if (editId) {
      const idx = DB.trips.findIndex(t => t.id === editId);
      if (idx >= 0) {
        obj.pres_vuelos      = DB.trips[idx].pres_vuelos || 0;
        obj.pres_hoteles     = DB.trips[idx].pres_hoteles || 0;
        obj.pres_transfers   = DB.trips[idx].pres_transfers || 0;
        obj.pres_excursiones = DB.trips[idx].pres_excursiones || 0;
        obj.pres_comidas     = DB.trips[idx].pres_comidas || 0;
        obj.pres_seguros     = DB.trips[idx].pres_seguros || 0;
        DB.trips[idx] = obj;
      }
    } else {
      DB.trips.push(obj);
    }
    State.tripId = id;
    App.saveDB();
    App.closeModal('dlgTrip');
    App.render();
    App.toast(editId ? 'Viaje actualizado âœ“' : 'Viaje creado âœ“', 'success');
  },

  editCurrent() {
    const t = App.currentTrip();
    if (t) this.openModal(t);
  },

  async deleteCurrent() {
    const t = App.currentTrip();
    if (!t) return;
    const ok = await App.confirm('Â¿Eliminar el viaje "' + t.nombre + '" y todos sus gastos?');
    if (!ok) return;
    DB.trips = DB.trips.filter(x => x.id !== t.id);
    DB.expenses = DB.expenses.filter(e => e.viaje_id !== t.id);
    DB.activities = DB.activities.filter(a => a.viaje_id !== t.id);
    State.tripId = null;
    App.saveDB();
    App.render();
    App.toast('Viaje eliminado', 'info');
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPENSES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Expenses = {

  onCatChange() {
    const cat = document.getElementById('fCat').value;
    const ff  = document.getElementById('flightFields');
    const nr  = document.getElementById('normalDateRow');
    if (cat === 'vuelos') {
      ff.style.display  = 'block';
      nr.style.display  = 'none';
      this._syncFlightDate();
    } else {
      ff.style.display  = 'none';
      nr.style.display  = '';
    }
  },

  _syncFlightDate() {
    const dep = document.getElementById('fDepDate').value;
    const arr = document.getElementById('fArrDate').value;
    // Auto-fill main date from departure date
    if (dep && !document.getElementById('fDate').value) {
      document.getElementById('fDate').value = dep;
    }
    // Next-day warning
    const badge = document.getElementById('nextDayBadge');
    if (dep && arr && arr > dep) {
      badge.style.display = '';
    } else {
      badge.style.display = 'none';
    }
  },

  filterCat(cat, el) {
    State.catFilter = cat;
    document.querySelectorAll('.cat-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    this.render();
  },

  render() {
    const t = App.currentTrip();
    const container = document.getElementById('expContainer');
    if (!t) {
      container.innerHTML = '<div class="empty-state"><div class="ei">ğŸ—‚</div><p>Selecciona un viaje para ver sus gastos</p></div>';
      document.getElementById('listTotal').textContent = '';
      return;
    }
    const search = document.getElementById('searchInp').value.toLowerCase();
    let exps = DB.expenses.filter(e => e.viaje_id === t.id);
    if (State.catFilter !== 'todas') exps = exps.filter(e => e.categoria === State.catFilter);
    if (search) exps = exps.filter(e =>
      (e.descripcion || '').toLowerCase().includes(search) ||
      (e.proveedor || '').toLowerCase().includes(search) ||
      (e.referencia || '').toLowerCase().includes(search)
    );
    exps.sort((a, b) => (b.fecha || '').localeCompare(a.fecha || ''));

    const toDisplay = (amt, cur) => {
      const eur = amt / (State.rates[cur] || 1);
      return eur * (State.rates[State.displayCur] || 1);
    };
    const fmt = n => {
      const sym = { EUR:'â‚¬', USD:'$', GBP:'Â£', JPY:'Â¥', MXN:'MX$', CHF:'Fr', CAD:'C$', AUD:'A$', BRL:'R$', THB:'à¸¿', COP:'COP' };
      return (sym[State.displayCur] || '') + fmtNum(n);
    };

    const catName = State.catFilter === 'todas' ? 'Todos los Gastos' : (CATS[State.catFilter]?.icon + ' ' + CATS[State.catFilter]?.label);
    document.getElementById('listTitle').textContent = catName;

    if (exps.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="ei">ğŸ“­</div><p>No hay gastos' + (search ? ' para esa bÃºsqueda' : '') + '</p></div>';
      document.getElementById('listTotal').textContent = '';
      return;
    }

    const total = exps.filter(e => e.estado !== 'cancelado').reduce((s, e) => s + toDisplay(e.importe, e.moneda), 0);
    document.getElementById('listTotal').textContent = State.showAmounts ? 'Total: ' + fmt(total) : '';

    container.innerHTML = '<div style="overflow-x:auto"><table class="exp-table"><thead><tr><th>DescripciÃ³n</th><th>CategorÃ­a</th><th>Estado</th><th>Importe</th><th>Fecha</th><th></th></tr></thead><tbody>' +
      exps.map(e => {
        const c = CATS[e.categoria] || { icon: 'ğŸ“Œ', label: e.categoria, color: 'var(--text2)' };
        const statusClass = 'status-' + (e.estado || 'pendiente');
        const dispAmt = toDisplay(e.importe, e.moneda);
        const originalAmt = State.showAmounts && e.moneda !== State.displayCur ? ` <span style="font-size:10px;color:var(--text3)">(${fmtNum(e.importe)} ${e.moneda})</span>` : '';
        return `<tr>
          <td data-label="">
            <div style="font-weight:600">${App.esc(e.descripcion)}</div>
            ${e.proveedor ? `<div style="font-size:11px;color:var(--text2)">${App.esc(e.proveedor)}${e.referencia ? ' Â· ' + App.esc(e.referencia) : ''}</div>` : ''}
          </td>
          <td data-label="CategorÃ­a"><span class="cat-pill" style="background:${c.color}22;color:${c.color}">${c.icon} ${c.label}</span></td>
          <td data-label="Estado"><span class="status-dot ${statusClass}">${e.estado || 'pendiente'}</span></td>
          <td data-label="Importe"><span class="mono">${State.showAmounts ? fmt(dispAmt) : 'Â·Â·Â·'}</span>${originalAmt}</td>
          <td data-label="Fecha" style="color:var(--text2);font-size:12px">${e.fecha || 'â€”'}</td>
          <td data-label="">
            <div style="display:flex;gap:4px">
              <button class="btn btn-ghost btn-xs" onclick="Expenses.edit('${e.id}')">âœ</button>
              <button class="btn btn-danger btn-xs" onclick="Expenses.delete('${e.id}')">ğŸ—‘</button>
            </div>
          </td>
        </tr>`;
      }).join('') + '</tbody></table></div>';
  },

  renderBadges() {
    const t = App.currentTrip();
    const exps = t ? DB.expenses.filter(e => e.viaje_id === t.id) : [];
    document.getElementById('cnt-todas').textContent = exps.length;
    Object.keys(CATS).forEach(c => {
      const el = document.getElementById('cnt-' + c);
      if (el) el.textContent = exps.filter(e => e.categoria === c).length;
    });
  },

  updateConvert() {
    const amt = parseFloat(document.getElementById('fAmount').value) || 0;
    const cur = document.getElementById('fCur').value;
    const el  = document.getElementById('convertInfo');
    const t   = App.currentTrip();
    if (!amt || !t) { el.style.display = 'none'; return; }
    const eur  = amt / (State.rates[cur] || 1);
    const base = eur * (State.rates[t.moneda] || 1);
    el.style.display = '';
    el.textContent = `â‰ˆ ${fmtNum(base)} ${t.moneda} (tipo de cambio estimado)`;
  },

  save() {
    const desc = document.getElementById('fDesc').value.trim();
    if (!desc) { App.toast('La descripciÃ³n es obligatoria', 'error'); return; }
    const t = App.currentTrip();
    if (!t) { App.toast('Selecciona un viaje primero', 'error'); return; }
    const editId = document.getElementById('fId').value;
    const id = editId || 'G' + Date.now();
    const amt = parseFloat(document.getElementById('fAmount').value) || 0;
    const cur = document.getElementById('fCur').value;
    const eur = amt / (State.rates[cur] || 1);
    const base = eur * (State.rates[t.moneda] || 1);
    const obj = {
      id, viaje_id: t.id,
      descripcion: desc,
      categoria:   document.getElementById('fCat').value,
      estado:      document.getElementById('fEstado').value,
      importe:     amt,
      moneda:      cur,
      importe_base: Math.round(base * 100) / 100,
      fecha:       document.getElementById('fDate').value || document.getElementById('fDepDate').value,
      proveedor:   document.getElementById('fProvider').value.trim(),
      referencia:  document.getElementById('fRef').value.trim(),
      notas:       document.getElementById('fNotes').value.trim(),
      dep_date:    document.getElementById('fDepDate').value,
      dep_time:    document.getElementById('fDepTime').value,
      arr_date:    document.getElementById('fArrDate').value,
      arr_time:    document.getElementById('fArrTime').value,
    };
    if (editId) {
      const idx = DB.expenses.findIndex(e => e.id === editId);
      if (idx >= 0) DB.expenses[idx] = obj;
    } else {
      DB.expenses.push(obj);
    }
    App.saveDB();
    this.cancelEdit();
    App.render();
    App.toast(editId ? 'Gasto actualizado âœ“' : 'Gasto guardado âœ“', 'success');
  },

  edit(id) {
    const e = DB.expenses.find(x => x.id === id);
    if (!e) return;
    document.getElementById('fId').value       = e.id;
    document.getElementById('fDesc').value     = e.descripcion || '';
    document.getElementById('fCat').value      = e.categoria || 'vuelos';
    document.getElementById('fEstado').value   = e.estado || 'pendiente';
    document.getElementById('fAmount').value   = e.importe || '';
    document.getElementById('fCur').value      = e.moneda || 'EUR';
    document.getElementById('fDate').value     = e.fecha || '';
    document.getElementById('fProvider').value = e.proveedor || '';
    document.getElementById('fDepDate').value  = e.dep_date || '';
    document.getElementById('fDepTime').value  = e.dep_time || '';
    document.getElementById('fArrDate').value  = e.arr_date || '';
    document.getElementById('fArrTime').value  = e.arr_time || '';
    Expenses.onCatChange();
    document.getElementById('fRef').value      = e.referencia || '';
    document.getElementById('fNotes').value    = e.notas || '';
    document.getElementById('expFormTitle').textContent = 'âœï¸ Editando Gasto';
    document.getElementById('btnSaveText').textContent  = 'ğŸ’¾ Actualizar Gasto';
    document.getElementById('btnCancelEdit').style.display = '';
    this.updateConvert();
    document.getElementById('view-gastos').scrollTo(0, 0);
    window.scrollTo(0, 0);
  },

  async delete(id) {
    const ok = await App.confirm('Â¿Eliminar este gasto?');
    if (!ok) return;
    DB.expenses = DB.expenses.filter(e => e.id !== id);
    App.saveDB();
    App.render();
    App.toast('Gasto eliminado', 'info');
  },

  cancelEdit() {
    document.getElementById('fId').value      = '';
    document.getElementById('fDesc').value    = '';
    document.getElementById('fAmount').value  = '';
    document.getElementById('fDate').value    = new Date().toISOString().slice(0,10);
    document.getElementById('fProvider').value = '';
    document.getElementById('fRef').value     = '';
    document.getElementById('fNotes').value   = '';
    document.getElementById('fCat').value     = 'vuelos';
    document.getElementById('fDepDate').value  = '';
    document.getElementById('fDepTime').value  = '';
    document.getElementById('fArrDate').value  = '';
    document.getElementById('fArrTime').value  = '';
    // vuelos is default â†’ show flight fields, hide normal date
    document.getElementById('flightFields').style.display    = 'block';
    document.getElementById('normalDateRow').style.display   = 'none';
    document.getElementById('nextDayBadge').style.display    = 'none';
    document.getElementById('fEstado').value  = 'pendiente';
    const t = App.currentTrip();
    document.getElementById('fCur').value     = t ? t.moneda : 'EUR';
    document.getElementById('expFormTitle').textContent     = 'â• Nuevo Gasto';
    document.getElementById('btnSaveText').textContent      = 'ğŸ’¾ Guardar Gasto';
    document.getElementById('btnCancelEdit').style.display  = 'none';
    document.getElementById('convertInfo').style.display    = 'none';
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ITINERARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Itin = {

  render() {
    const t = App.currentTrip();
    const nav = document.getElementById('dayNav');
    if (!t || !t.fecha_inicio || !t.fecha_fin) {
      nav.innerHTML = '';
      document.getElementById('dayHeader').style.display = 'none';
      document.getElementById('timeline').innerHTML = '<div class="empty-state"><div class="ei">ğŸ—“</div><p>Selecciona un viaje con fechas de inicio y fin para ver el itinerario dÃ­a a dÃ­a</p></div>';
      return;
    }
    const days = this.getDays(t);
    if (!State.currentDay || !days.includes(State.currentDay)) {
      State.currentDay = days[0];
    }
    // Render day chips
    nav.innerHTML = days.map((d, i) => {
      const active = d === State.currentDay ? ' active' : '';
      const dt = new Date(d + 'T12:00:00');
      const dayName = dt.toLocaleDateString('es-ES', { weekday: 'short' });
      const dayNum2 = dt.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
      const actCount = DB.activities.filter(a => a.viaje_id === (App.currentTrip()?.id) && a.fecha === d).length;
      const dot = actCount > 0 ? `<span style="display:inline-block;width:6px;height:6px;background:currentColor;border-radius:50%;margin-bottom:2px;opacity:.6"></span> ` : '';
      return `<div class="day-chip${active}" onclick="Itin.selectDay('${d}')"><span class="dc-num">DÃ­a ${i+1}</span><span class="dc-date">${dayName} ${dayNum2}</span></div>`;
    }).join('');
    this.renderTimeline();
  },

  getDays(t) {
    const days = [];
    let d = new Date(t.fecha_inicio + 'T12:00:00');
    const end = new Date(t.fecha_fin + 'T12:00:00');
    while (d <= end) {
      days.push(d.toISOString().slice(0, 10));
      d.setDate(d.getDate() + 1);
    }
    return days;
  },

  selectDay(date) {
    State.currentDay = date;
    // Update chips
    document.querySelectorAll('.day-chip').forEach(c => {
      c.classList.toggle('active', c.textContent.includes(date.slice(8)) || c.onclick?.toString().includes(date));
    });
    // Re-render nav to properly highlight
    const t = App.currentTrip();
    if (t) {
      const days = this.getDays(t);
      const nav = document.getElementById('dayNav');
      nav.innerHTML = days.map((d, i) => {
        const active = d === State.currentDay ? ' active' : '';
        const dt2 = new Date(d + 'T12:00:00');
        const dayName2 = dt2.toLocaleDateString('es-ES', { weekday: 'short' });
        const dayNum3 = dt2.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
        return `<div class="day-chip${active}" onclick="Itin.selectDay('${d}')"><span class="dc-num">DÃ­a ${i+1}</span><span class="dc-date">${dayName2} ${dayNum3}</span></div>`;
      }).join('');
    }
    this.renderTimeline();
  },

  renderTimeline() {
    const t = App.currentTrip();
    if (!t || !State.currentDay) return;

    const dayEl = document.getElementById('dayHeader');
    dayEl.style.display = '';
    const days = this.getDays(t);
    const dayNum = days.indexOf(State.currentDay) + 1;
    document.getElementById('dhTitle').textContent = 'DÃ­a ' + dayNum;
    const dateStr = new Date(State.currentDay + 'T12:00:00').toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
    const dayLabel = t.dayLabels && t.dayLabels[State.currentDay];
    const dhDate = document.getElementById('dhDate');
    if (dayLabel) {
      dhDate.innerHTML = `<span style="color:var(--text2)">${dateStr}</span> <span style="background:linear-gradient(90deg,var(--blue),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-weight:700;font-size:14px;letter-spacing:.3px"> Â· ${dayLabel}</span>`;
    } else {
      dhDate.textContent = dateStr;
    }

    const acts = DB.activities
      .filter(a => a.viaje_id === t.id && a.fecha === State.currentDay)
      .sort((a, b) => (a.hora_inicio || '99:99').localeCompare(b.hora_inicio || '99:99'));

    // Day stats
    const totalCost = acts.reduce((s, a) => s + (a.coste || 0), 0);
    document.getElementById('dhActs').textContent = acts.length;
    document.getElementById('dhCost').textContent = totalCost > 0 && State.showAmounts ? totalCost.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.') + ' ' + (t.moneda || 'EUR') : (State.showAmounts ? 'â€”' : 'Â·Â·Â·');

    const tl = document.getElementById('timeline');
    if (acts.length === 0) {
      tl.innerHTML = '<div class="empty-state"><div class="ei">âœ¨</div><p>No hay actividades para este dÃ­a.<br>AÃ±ade una con el formulario.</p></div>';
      return;
    }

    const statusLabels = { pendiente:'Pendiente', reservado:'Reservado', pagado:'Pagado', cancelado:'Cancelado' };

    tl.innerHTML = acts.map(function(a, i) {
      var icon = ACT_ICONS[a.tipo] || 'ğŸ“Œ';
      var dotClass = 'tl-dot ' + (a.tipo || 'otro');
      var time = a.hora_inicio ? (a.hora_inicio + (a.hora_fin ? ' â†’ ' + a.hora_fin : '')) : '';
      var status = a.estado || 'pendiente';
      var sLabel = { pendiente:'Pendiente', reservado:'Reservado', pagado:'Pagado', cancelado:'Cancelado' };
      var meta = [];
      if (a.lugar) meta.push('<span>ğŸ“ ' + App.esc(a.lugar) + '</span>');
      if (a.coste > 0 && State.showAmounts) meta.push('<span class="tl-cost">ğŸ’¶ ' + a.coste.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.') + ' ' + (t.moneda || 'EUR') + '</span>');
      if (a.referencia) meta.push('<span>ğŸ”– ' + App.esc(a.referencia) + '</span>');
      var timeHtml  = time ? '<div class="tl-time">â° ' + time + '</div>' : '';
      var metaHtml  = meta.length ? '<div class="tl-meta">' + meta.join('') + '</div>' : '';
      var notesHtml = a.notas ? '<div style="margin-top:6px;font-size:11px;color:var(--text3);font-style:italic">' + App.esc(a.notas) + '</div>' : '';
      return '<div class="tl-item" style="animation-delay:' + (i * 0.07) + 's">' +
        '<div class="tl-dot-wrap">' +
          '<div class="' + dotClass + '">' + icon + '</div>' +
          '<div class="tl-connector"></div>' +
        '</div>' +
        '<div class="tl-card">' +
          '<div class="tl-card-header">' +
            '<div>' + timeHtml + '<div class="tl-title">' + App.esc(a.titulo) + '</div></div>' +
            '<div style="display:flex;gap:6px;align-items:flex-start;flex-shrink:0">' +
              '<span class="tl-status ' + status + '">' + (sLabel[status] || status) + '</span>' +
              '<div class="tl-actions">' +
                '<button class="btn btn-ghost btn-xs" onclick="Itin.editActivity(\'' + a.id + '\')">âœ</button>' +
                '<button class="btn btn-danger btn-xs" onclick="Itin.deleteActivity(\'' + a.id + '\')">ğŸ—‘</button>' +
              '</div>' +
            '</div>' +
          '</div>' +
          metaHtml + notesHtml +
        '</div>' +
      '</div>';
    }).join('');
  },

  onTypeChange() {
    var tipo = document.getElementById('actType').value;
    var ff = document.getElementById('actFlightFields');
    var nt = document.getElementById('actNormalTimes');
    if (tipo === 'vuelo') {
      ff.style.display = 'block';
      nt.style.display = 'none';
    } else {
      ff.style.display = 'none';
      nt.style.display = '';
    }
  },

  syncFlightDate() {
    var dep = document.getElementById('actDepDate').value;
    var arr = document.getElementById('actArrDate').value;
    var badge = document.getElementById('actNextDay');
    badge.style.display = (dep && arr && arr > dep) ? '' : 'none';
  },

  saveActivity() {
    const title = document.getElementById('actTitle').value.trim();
    if (!title) { App.toast('El tÃ­tulo es obligatorio', 'error'); return; }
    const t = App.currentTrip();
    if (!t) { App.toast('Selecciona un viaje primero', 'error'); return; }
    if (!State.currentDay) { App.toast('Selecciona un dÃ­a en el itinerario', 'error'); return; }
    const editId = document.getElementById('actId').value;
    const id = editId || 'A' + Date.now();
    const obj = {
      id, viaje_id: t.id, fecha: State.currentDay,
      titulo:      title,
      tipo:        document.getElementById('actType').value,
      estado:      document.getElementById('actEstado').value,
      hora_inicio: document.getElementById('actType').value === 'vuelo'
                   ? document.getElementById('actDepTime').value
                   : document.getElementById('actStart').value,
      hora_fin:    document.getElementById('actType').value === 'vuelo'
                   ? document.getElementById('actArrTime').value
                   : document.getElementById('actEnd').value,
      dep_date:    document.getElementById('actDepDate').value,
      dep_time:    document.getElementById('actDepTime').value,
      arr_date:    document.getElementById('actArrDate').value,
      arr_time:    document.getElementById('actArrTime').value,
      lugar:       document.getElementById('actLugar').value.trim(),
      coste:       parseFloat(document.getElementById('actCoste').value) || 0,
      referencia:  document.getElementById('actRef').value.trim(),
      url:         document.getElementById('actUrl').value.trim(),
      notas:       document.getElementById('actNotes').value.trim(),
    };
    if (editId) {
      const idx = DB.activities.findIndex(a => a.id === editId);
      if (idx >= 0) DB.activities[idx] = obj;
    } else {
      DB.activities.push(obj);
    }
    App.saveDB();
    this.cancelEdit();
    this.renderTimeline();
    App.toast(editId ? 'Actividad actualizada âœ“' : 'Actividad guardada âœ“', 'success');
  },

  editActivity(id) {
    const a = DB.activities.find(x => x.id === id);
    if (!a) return;
    document.getElementById('actId').value     = a.id;
    document.getElementById('actTitle').value  = a.titulo || '';
    document.getElementById('actType').value   = a.tipo || 'visita';
    document.getElementById('actEstado').value = a.estado || 'pendiente';
    document.getElementById('actStart').value   = a.hora_inicio || '';
    document.getElementById('actEnd').value     = a.hora_fin || '';
    document.getElementById('actDepDate').value = a.dep_date || '';
    document.getElementById('actDepTime').value = a.dep_time || '';
    document.getElementById('actArrDate').value = a.arr_date || '';
    document.getElementById('actArrTime').value = a.arr_time || '';
    Itin.onTypeChange();
    document.getElementById('actLugar').value  = a.lugar || '';
    document.getElementById('actCoste').value  = a.coste || '';
    document.getElementById('actRef').value    = a.referencia || '';
    document.getElementById('actUrl').value    = a.url || '';
    document.getElementById('actNotes').value  = a.notas || '';
    document.getElementById('actFormTitle').textContent  = 'âœï¸ Editando Actividad';
    document.getElementById('btnActText').textContent    = 'ğŸ’¾ Actualizar';
    document.getElementById('btnCancelAct').style.display = '';
  },

  async deleteActivity(id) {
    const ok = await App.confirm('Â¿Eliminar esta actividad?');
    if (!ok) return;
    DB.activities = DB.activities.filter(a => a.id !== id);
    App.saveDB();
    this.renderTimeline();
    App.toast('Actividad eliminada', 'info');
  },

  cancelEdit() {
    ['actId','actTitle','actStart','actEnd','actLugar','actRef','actUrl','actNotes'].forEach(id => {
      document.getElementById(id).value = '';
    });
    document.getElementById('actCoste').value = '';
    document.getElementById('actType').value    = 'visita';
    document.getElementById('actDepDate').value = '';
    document.getElementById('actDepTime').value = '';
    document.getElementById('actArrDate').value = '';
    document.getElementById('actArrTime').value = '';
    document.getElementById('actFlightFields').style.display = 'none';
    document.getElementById('actNormalTimes').style.display  = '';
    document.getElementById('actNextDay').style.display      = 'none';
    document.getElementById('actEstado').value = 'pendiente';
    document.getElementById('actFormTitle').textContent  = 'â• Nueva Actividad';
    document.getElementById('btnActText').textContent    = 'ğŸ’¾ Guardar Actividad';
    document.getElementById('btnCancelAct').style.display = 'none';
  },

  prevDay() {
    const t = App.currentTrip();
    if (!t) return;
    const days = this.getDays(t);
    const idx = days.indexOf(State.currentDay);
    if (idx > 0) this.selectDay(days[idx - 1]);
  },

  nextDay() {
    const t = App.currentTrip();
    if (!t) return;
    const days = this.getDays(t);
    const idx = days.indexOf(State.currentDay);
    if (idx < days.length - 1) this.selectDay(days[idx + 1]);
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHARTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Charts = {

  render() {
    this.renderCat();
    this.renderStatus();
    this.renderDate();
    this.renderCur();
  },

  fmt(n) {
    const sym = { EUR:'â‚¬', USD:'$', GBP:'Â£', JPY:'Â¥', MXN:'MX$', CHF:'Fr', CAD:'C$', AUD:'A$', BRL:'R$', THB:'à¸¿', COP:'COP' };
    return (sym[State.displayCur] || '') + fmtNum(n);
  },

  toDisplay(amt, cur) {
    return (amt / (State.rates[cur] || 1)) * (State.rates[State.displayCur] || 1);
  },

  bars(el, items, max) {
    if (!items.length) { el.innerHTML = '<div style="text-align:center;color:var(--text3);padding:20px">Sin datos</div>'; return; }
    el.innerHTML = items.map(it =>
      `<div class="bar-row">
        <div class="bar-label" title="${App.esc(it.label)}">${it.icon || ''} ${App.esc(it.label)}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${max > 0 ? (it.val/max*100).toFixed(1) : 0}%;background:${it.color}"></div></div>
        <div class="bar-val">${State.showAmounts ? this.fmt(it.val) : "Â·Â·Â·"}</div>
      </div>`
    ).join('');
  },

  renderCat() {
    const t = App.currentTrip();
    const el = document.getElementById('chartCat');
    if (!t) { el.innerHTML = '<div class="empty-state" style="padding:20px"><p>Selecciona un viaje</p></div>'; return; }
    const exps = DB.expenses.filter(e => e.viaje_id === t.id && e.estado !== 'cancelado');
    const totals = {};
    exps.forEach(e => {
      totals[e.categoria] = (totals[e.categoria] || 0) + this.toDisplay(e.importe, e.moneda);
    });
    const items = Object.entries(CATS).map(([k, v]) => ({ label: v.label, icon: v.icon, val: totals[k] || 0, color: v.color }))
      .filter(x => x.val > 0).sort((a, b) => b.val - a.val);
    this.bars(el, items, items[0]?.val || 1);
  },

  renderStatus() {
    const t = App.currentTrip();
    const el = document.getElementById('chartStatus');
    if (!t) { el.innerHTML = '<div class="empty-state" style="padding:20px"><p>Selecciona un viaje</p></div>'; return; }
    const exps = DB.expenses.filter(e => e.viaje_id === t.id);
    const statuses = { pagado: { label: 'Pagado', color: 'var(--green)' }, reservado: { label: 'Reservado', color: 'var(--blue)' }, pendiente: { label: 'Pendiente', color: 'var(--yellow)' }, cancelado: { label: 'Cancelado', color: 'var(--text3)' } };
    const items = Object.entries(statuses).map(([k, v]) => ({
      label: v.label, icon: '', val: exps.filter(e => e.estado === k).reduce((s, e) => s + this.toDisplay(e.importe, e.moneda), 0), color: v.color
    })).filter(x => x.val > 0).sort((a, b) => b.val - a.val);
    this.bars(el, items, items[0]?.val || 1);
  },

  renderDate() {
    const t = App.currentTrip();
    const el = document.getElementById('chartDate');
    if (!t) { el.innerHTML = '<div class="empty-state" style="padding:20px"><p>Selecciona un viaje</p></div>'; return; }
    const byDate = {};
    DB.expenses.filter(e => e.viaje_id === t.id && e.estado !== 'cancelado' && e.fecha).forEach(e => {
      byDate[e.fecha] = (byDate[e.fecha] || 0) + this.toDisplay(e.importe, e.moneda);
    });
    const items = Object.entries(byDate).sort((a, b) => a[0].localeCompare(b[0]))
      .map(([d, v]) => ({ label: d, icon: '', val: v, color: 'var(--blue)' }));
    this.bars(el, items, items.reduce((m, x) => Math.max(m, x.val), 1));
  },

  renderCur() {
    const t = App.currentTrip();
    const el = document.getElementById('chartCur');
    if (!t) { el.innerHTML = '<div class="empty-state" style="padding:20px"><p>Selecciona un viaje</p></div>'; return; }
    const byCur = {};
    DB.expenses.filter(e => e.viaje_id === t.id && e.estado !== 'cancelado').forEach(e => {
      byCur[e.moneda] = (byCur[e.moneda] || 0) + e.importe;
    });
    const colors = ['var(--blue)', 'var(--green)', 'var(--yellow)', 'var(--red)', 'var(--purple)', 'var(--orange)'];
    const items = Object.entries(byCur).sort((a, b) => b[1] - a[1])
      .map(([cur, v], i) => ({ label: cur, icon: '', val: v, color: colors[i % colors.length] }));
    // For currency chart show original amounts
    if (!items.length) { el.innerHTML = '<div class="empty-state" style="padding:20px"><p>Sin datos</p></div>'; return; }
    const max = items[0].val;
    el.innerHTML = items.map(it =>
      `<div class="bar-row">
        <div class="bar-label">${App.esc(it.label)}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${(it.val/max*100).toFixed(1)}%;background:${it.color}"></div></div>
        <div class="bar-val" style="font-family:'Space Mono',monospace;font-size:11px">${State.showAmounts ? fmtNum(it.val) : "Â·Â·Â·"}</div>
      </div>`
    ).join('');
  },

  renderBudget() {
    const t = App.currentTrip();
    const grid = document.getElementById('bvrGrid');
    if (!t) {
      grid.innerHTML = '<div class="empty-state" style="padding:20px"><p>Selecciona un viaje</p></div>';
      return;
    }
    const toDisplay = (amt, cur) => (amt / (State.rates[cur] || 1)) * (State.rates[State.displayCur] || 1);
    const fmt = n => {
      const sym = { EUR:'â‚¬', USD:'$', GBP:'Â£', JPY:'Â¥', MXN:'MX$', CHF:'Fr' };
      return (sym[State.displayCur] || '') + fmtNum(n);
    };

    const rows = Object.entries(CATS).map(([cat, info]) => {
      const plan = toDisplay(t['pres_' + cat] || 0, t.moneda);
      const real = DB.expenses.filter(e => e.viaje_id === t.id && e.categoria === cat && e.estado !== 'cancelado')
        .reduce((s, e) => s + toDisplay(e.importe, e.moneda), 0);
      const max = Math.max(plan, real, 1);
      const pct = plan > 0 ? Math.min(real / plan * 100, 200) : 0;
      const color = pct > 100 ? 'var(--red)' : pct > 80 ? 'var(--yellow)' : 'var(--green)';
      return `<div class="bvr-row">
        <div class="bvr-cat" style="color:${info.color}">${info.icon} ${info.label}</div>
        <div class="bvr-bars">
          <div class="bvr-bar-row">
            <div class="bvr-bar-label">Plan</div>
            <div class="bvr-track"><div class="bvr-fill" style="width:${(plan/max*100).toFixed(1)}%;background:${info.color};opacity:.35"></div></div>
            <div class="bvr-val" style="color:var(--text2)">${State.showAmounts ? fmt(plan) : "Â·Â·Â·"}</div>
          </div>
          <div class="bvr-bar-row">
            <div class="bvr-bar-label">Real</div>
            <div class="bvr-track"><div class="bvr-fill" style="width:${(real/max*100).toFixed(1)}%;background:${color}"></div></div>
            <div class="bvr-val" style="color:${color}">${State.showAmounts ? fmt(real) : "Â·Â·Â·"}</div>
          </div>
        </div>
        <div style="width:50px;text-align:right;font-size:12px;font-weight:700;color:${color}">
          <div style="cursor:pointer" onclick="Charts.editBudget('${cat}')" title="Editar presupuesto">${plan > 0 ? pct.toFixed(0) + '%' : 'â€”'}</div>
        </div>
      </div>`;
    }).join('');
    grid.innerHTML = rows;
    this.renderCompare();
    this.renderUtil();
  },

  editBudget(cat) {
    const t = App.currentTrip();
    if (!t) return;
    const cur = (t['pres_' + cat] || 0).toString();
    const val = prompt('Presupuesto para ' + CATS[cat].label + ' (en ' + t.moneda + '):', cur);
    if (val === null) return;
    const num = parseFloat(val) || 0;
    const idx = DB.trips.findIndex(x => x.id === t.id);
    if (idx >= 0) {
      DB.trips[idx]['pres_' + cat] = num;
      App.saveDB();
      this.renderBudget();
      App.renderStats();
    }
  },

  renderCompare() {
    const t = App.currentTrip();
    const el = document.getElementById('chartCompare');
    if (!t) return;
    const toDisplay = (amt, cur) => (amt / (State.rates[cur] || 1)) * (State.rates[State.displayCur] || 1);
    const fmt = n => fmtNum(n);
    const items = Object.entries(CATS).map(([cat, info]) => {
      const plan = toDisplay(t['pres_' + cat] || 0, t.moneda);
      const real = DB.expenses.filter(e => e.viaje_id === t.id && e.categoria === cat && e.estado !== 'cancelado').reduce((s, e) => s + toDisplay(e.importe, e.moneda), 0);
      return { cat, info, plan, real };
    }).filter(x => x.plan > 0 || x.real > 0);
    const max = Math.max(...items.flatMap(x => [x.plan, x.real]), 1);
    el.innerHTML = items.map(x =>
      `<div class="bar-row" style="margin-bottom:14px">
        <div class="bar-label" style="color:${x.info.color}">${x.info.icon} ${x.info.label}</div>
        <div style="flex:1">
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:3px">
            <div style="width:36px;font-size:10px;color:var(--text3)">Plan</div>
            <div class="bar-track" style="flex:1"><div class="bar-fill" style="width:${(x.plan/max*100).toFixed(1)}%;background:${x.info.color};opacity:.35"></div></div>
            <div style="font-size:10px;color:var(--text2);width:60px;text-align:right">${State.showAmounts ? fmt(x.plan) : "Â·Â·Â·"}</div>
          </div>
          <div style="display:flex;align-items:center;gap:6px">
            <div style="width:36px;font-size:10px;color:var(--text3)">Real</div>
            <div class="bar-track" style="flex:1"><div class="bar-fill" style="width:${(x.real/max*100).toFixed(1)}%;background:${x.info.color}"></div></div>
            <div style="font-size:10px;color:var(--text2);width:60px;text-align:right">${State.showAmounts ? fmt(x.real) : "Â·Â·Â·"}</div>
          </div>
        </div>
      </div>`
    ).join('') || '<div style="text-align:center;color:var(--text3);padding:20px">Define presupuestos por categorÃ­a</div>';
  },

  renderUtil() {
    const t = App.currentTrip();
    const el = document.getElementById('chartUtil');
    if (!t) return;
    const toDisplay = (amt, cur) => (amt / (State.rates[cur] || 1)) * (State.rates[State.displayCur] || 1);
    const items = Object.entries(CATS).map(([cat, info]) => {
      const plan = toDisplay(t['pres_' + cat] || 0, t.moneda);
      const real = DB.expenses.filter(e => e.viaje_id === t.id && e.categoria === cat && e.estado !== 'cancelado').reduce((s, e) => s + toDisplay(e.importe, e.moneda), 0);
      return { info, plan, real, pct: plan > 0 ? Math.min(real / plan * 100, 200) : 0 };
    }).filter(x => x.plan > 0);
    el.innerHTML = items.map(x => {
      const color = x.pct > 100 ? 'var(--red)' : x.pct > 80 ? 'var(--yellow)' : 'var(--green)';
      return `<div class="bar-row">
        <div class="bar-label" style="color:${x.info.color}">${x.info.icon} ${x.info.label}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${Math.min(x.pct, 100).toFixed(1)}%;background:${color}"></div></div>
        <div class="bar-val" style="color:${color};font-size:11px">${x.pct.toFixed(0)}%</div>
      </div>`;
    }).join('') || '<div style="text-align:center;color:var(--text3);padding:20px">Define presupuestos por categorÃ­a</div>';
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Sheets = {

  SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbxkNporvgUitahCpfvumKysZ2vjenNzvdFuro5iGGhsZUr-LanFTfbZeEJcc_GFWWaYEg/exec',

  openConfig() {
    document.getElementById('cfgScript').value = CFG.scriptUrl || this.SCRIPT_URL;
    document.getElementById('cfgSecret').value = CFG.secret || '';
    document.getElementById('btnDisconnect').style.display = CFG.scriptUrl ? '' : 'none';
    document.getElementById('sheetsStatus').className = 'status-msg';
    document.getElementById('sheetsStatus').textContent = '';
    App.openModal('dlgSheets');
  },

  async connect() {
    const script = document.getElementById('cfgScript').value.trim();
    const secret = document.getElementById('cfgSecret').value.trim();
    if (!script || !secret) {
      this.status('Introduce la URL del script y la clave secreta', 'err');
      return;
    }
    this.status('Verificando conexiÃ³nâ€¦', 'loading');
    try {
      const r = await this.call({ action: 'loadAll', secret });
      if (r.error) { this.status('Error: ' + r.error, 'err'); return; }
      CFG.scriptUrl = script;
      CFG.secret    = secret;
      CFG.save();
      this._setBadge(true);
      // Si hay datos en Sheets, cargarlos
      const hasData = (r.trips && r.trips.length > 0);
      if (hasData) {
        this._importFromSheets(r);
        App.render();
        this.status('Â¡Conectado! Datos cargados desde Sheets âœ“', 'ok');
      } else {
        // Sheets vacÃ­o â€” subir datos locales
        await this.pushToSheets();
        this.status('Â¡Conectado! Datos locales subidos a Sheets âœ“', 'ok');
      }
      setTimeout(() => App.closeModal('dlgSheets'), 1800);
    } catch(e) {
      this.status('Error de red: ' + e.message, 'err');
    }
  },

  async sync() {
    if (!CFG.scriptUrl) { App.toast('Conecta Sheets primero', 'error'); return; }
    const btn = document.getElementById('btnSync');
    btn.textContent = 'â³';
    btn.disabled = true;
    try {
      // 1. Cargar desde Sheets
      const r = await this.call({ action: 'loadAll', secret: CFG.secret });
      if (r.error) throw new Error(r.error);
      // 2. Merge: Sheets tiene prioridad para datos existentes, local aÃ±ade los nuevos
      this._importFromSheets(r);
      // 3. Subir estado final a Sheets
      await this.pushToSheets();
      App.render();
      App.toast('Sincronizado con Sheets âœ“', 'success');
    } catch(e) {
      App.toast('Error al sincronizar: ' + e.message, 'error');
    } finally {
      btn.textContent = 'â˜ï¸';
      btn.disabled = false;
    }
  },

  async pushToSheets() {
    const toRows = (arr) => {
      if (!arr.length) return [];
      const keys = Object.keys(arr[0]);
      return [keys, ...arr.map(o => keys.map(k => o[k] ?? ''))];
    };
    await this.call({
      action:     'syncAll',
      secret:     CFG.secret,
      trips:      toRows(DB.trips),
      expenses:   toRows(DB.expenses),
      activities: toRows(DB.activities),
    });
  },

  _importFromSheets(r) {
    const toObjs = (rows) => {
      if (!rows || rows.length < 2) return [];
      const [headers, ...data] = rows;
      return data.map(row => {
        const obj = {};
        headers.forEach((h, i) => { obj[h] = row[i] ?? ''; });
        // Convert numeric strings back to numbers where needed
        ['presupuesto','importe','importe_base','coste'].forEach(k => {
          if (obj[k] !== '' && obj[k] !== undefined) obj[k] = Number(obj[k]) || 0;
        });
        // Parse dayLabels if stored as JSON string
        if (obj.dayLabels && typeof obj.dayLabels === 'string') {
          try { obj.dayLabels = JSON.parse(obj.dayLabels); } catch(e) { obj.dayLabels = {}; }
        }
        return obj;
      });
    };
    if (r.trips      && r.trips.length)      DB.trips      = toObjs(r.trips);
    if (r.expenses   && r.expenses.length)   DB.expenses   = toObjs(r.expenses);
    if (r.activities && r.activities.length) DB.activities = toObjs(r.activities);
    App.saveDB();
  },

  async call(body) {
    const url = CFG.scriptUrl || this.SCRIPT_URL;
    const r = await fetch(url, {
      method:  'POST',
      body:    JSON.stringify(body),
    });
    return r.json();
  },

  async disconnect() {
    const ok = await App.confirm('Â¿Desconectar Google Sheets y usar datos locales?');
    if (!ok) return;
    CFG.scriptUrl = ''; CFG.secret = '';
    CFG.save();
    this._setBadge(false);
    document.getElementById('btnSync').style.display = 'none';
    App.closeModal('dlgSheets');
    App.toast('Desconectado â€” usando datos locales', 'info');
  },

  _setBadge(connected) {
    const badge = document.getElementById('connBadge');
    const sync  = document.getElementById('btnSync');
    if (connected) {
      badge.textContent = 'â— Sheets';
      badge.style.color = 'var(--green)';
      badge.style.display = '';
      sync.style.display = '';
    } else {
      badge.style.display = 'none';
      sync.style.display = 'none';
    }
  },

  status(msg, type) {
    const el = document.getElementById('sheetsStatus');
    el.className = 'status-msg ' + type;
    el.textContent = msg;
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHARE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Share = {
  openItinerary() {
    const t = App.currentTrip();
    if (!t) { App.toast('Selecciona un viaje primero', 'error'); return; }
    const text = this.buildText(t);
    const opts = document.getElementById('shareOptions');
    const html = this.buildHTML(t);
    const options = [
      { icon: 'ğŸŒ', name: 'Ver y descargar HTML', desc: 'Abre el diseÃ±o completo â€” idÃ©ntico a la app Â· descarga el archivo para enviarlo', action: `Share._preview()` },
      { icon: 'ğŸ’¬', name: 'WhatsApp (texto)', desc: 'Itinerario en texto con emojis â€” sin diseÃ±o visual', action: `Share._whatsapp()` },
      { icon: 'ğŸ“§', name: 'Email (texto)', desc: 'Abre tu cliente de correo con el itinerario en texto', action: `Share._email()` },
      { icon: 'ğŸ“‹', name: 'Copiar texto', desc: 'Texto plano para pegar en cualquier app', action: `Share._copy()` },
    ];
    const infoHtml = `<div style="background:rgba(79,142,247,.08);border:1px solid rgba(79,142,247,.2);border-radius:10px;padding:12px 14px;margin-bottom:12px;font-size:12px;color:var(--text2);line-height:1.6">
      ğŸ’¡ Para compartir con el <strong style="color:var(--text)">diseÃ±o visual completo</strong>, usa <em>Ver y descargar HTML</em> y envÃ­a el archivo adjunto por WhatsApp o email.
    </div>`;
    opts.innerHTML = infoHtml + options.map(o => `<div class="share-opt" onclick="${o.action}">
      <div class="share-icon">${o.icon}</div>
      <div class="share-info"><div class="name">${o.name}</div><div class="desc">${o.desc}</div></div>
    </div>`).join('');
    this._text = text;
    this._html = html;
    App.openModal('dlgShare');
  },

  buildText(t) {
    const tipoEmoji = { vuelo:'âœˆï¸', transporte:'ğŸšŒ', alojamiento:'ğŸ¨', visita:'ğŸ›', comida:'ğŸ½', compras:'ğŸ›', actividad:'ğŸ¯', otro:'ğŸ“Œ' };
    const estadoBadge = { pendiente:'â³', reservado:'ğŸ”µ', pagado:'âœ…', cancelado:'âŒ' };
    const days = Itin.getDays(t);
    // Stats
    const allActs = DB.activities.filter(a => a.viaje_id === t.id);
    const totalCost = allActs.reduce((s, a) => s + (a.coste || 0), 0);
    const budget = t.presupuesto || 0;
    const moneda = t.moneda || 'EUR';

    let out = `âœˆ *${t.nombre}*\n`;
    out += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    if (t.destino) out += `ğŸ“ ${t.destino}\n`;
    if (t.fecha_inicio) out += `ğŸ“… ${t.fecha_inicio} â†’ ${t.fecha_fin}\n`;
    if (budget > 0) out += `ğŸ’° Presupuesto: ${budget.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.')} ${moneda}\n`;
    out += `ğŸ—“ ${days.length} dÃ­as Â· ${allActs.length} actividades\n`;
    out += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;

    days.forEach((d, i) => {
      const acts = DB.activities.filter(a => a.viaje_id === t.id && a.fecha === d).sort((a, b) => (a.hora_inicio || '').localeCompare(b.hora_inicio || ''));
      if (acts.length === 0) return;
      const dt = new Date(d + 'T12:00:00').toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
      const dayCost = acts.reduce((s, a) => s + (a.coste || 0), 0);
      out += `*DÃ­a ${i+1} Â· ${dt}*`;
      if (dayCost > 0) out += `  ğŸ’¶ ${dayCost.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.')} ${moneda}`;
      out += `\n`;
      acts.forEach(a => {
        const emoji = tipoEmoji[a.tipo] || 'ğŸ“Œ';
        const badge = estadoBadge[a.estado] || '';
        const time = a.hora_inicio ? `[${a.hora_inicio}${a.hora_fin ? 'â†’'+a.hora_fin : ''}]` : '';
        out += `  ${emoji} ${time ? time+' ' : ''}${a.titulo}`;
        if (a.coste > 0) out += ` Â· ğŸ’¶ ${a.coste.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.')} ${moneda}`;
        if (badge) out += ` ${badge}`;
        out += `\n`;
        if (a.lugar) out += `     ğŸ“ ${a.lugar}\n`;
        if (a.notas) out += `     ğŸ’¬ ${a.notas}\n`;
      });
      out += '\n';
    });

    out += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    if (totalCost > 0) out += `ğŸ’¸ Gasto total: ${totalCost.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.')} ${moneda}\n`;
    if (budget > 0 && totalCost > 0) {
      const rem = budget - totalCost;
      out += `${rem >= 0 ? 'âœ…' : 'âš ï¸'} ${rem >= 0 ? 'Disponible' : 'Exceso'}: ${fmtNum(Math.abs(rem))} ${moneda}\n`;
    }
    out += `\n_Generado con âœˆ AVENTURA360_`;
    return out;
  },

  async _copy() {
    try {
      await navigator.clipboard.writeText(this._text);
      App.toast('Copiado al portapapeles âœ“', 'success');
    } catch(e) {
      App.toast('No se pudo copiar. Usa el texto manualmente.', 'error');
    }
    App.closeModal('dlgShare');
  },

  _whatsapp() {
    const url = 'https://wa.me/?text=' + encodeURIComponent(this._text);
    window.open(url, '_blank');
    App.closeModal('dlgShare');
  },

  _email() {
    const t = App.currentTrip();
    const subject = encodeURIComponent('âœˆ ' + (t ? t.nombre : 'Itinerario') + ' â€” Aventura360');
    const body = encodeURIComponent(this._text);
    window.open('mailto:?subject=' + subject + '&body=' + body);
    App.closeModal('dlgShare');
  },

  _download() {
    App.closeModal('dlgShare');
    const t = App.currentTrip();
    const filename = (t ? t.nombre.replace(/[^a-z0-9Ã¡Ã©Ã­Ã³ÃºÃ±]/gi,'_') : 'itinerario') + '.html';
    const blob = new Blob([this._html], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  },

  async _native() {
    App.closeModal('dlgShare');
    const t = App.currentTrip();
    const filename = (t ? t.nombre.replace(/[^a-z0-9Ã¡Ã©Ã­Ã³ÃºÃ±]/gi,'_') : 'itinerario') + '.html';
    try {
      const blob = new Blob([this._html], { type: 'text/html' });
      const file = new File([blob], filename, { type: 'text/html' });
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({ files: [file], title: t ? t.nombre : 'Itinerario', text: 'Mi itinerario de viaje â€” Aventura360' });
      } else {
        await navigator.share({ title: t ? t.nombre : 'Itinerario', text: this._text });
      }
    } catch(e) { if (e.name !== 'AbortError') App.toast('Error al compartir: ' + e.message, 'error'); }
  },

  _preview() {
    App.closeModal('dlgShare');
    const t = App.currentTrip();
    const filename = (t ? t.nombre.replace(/[^a-z0-9]/gi,'_') : 'itinerario') + '.html';
    // Add download button to the HTML
    const downloadBtn = `<div style="position:fixed;bottom:20px;right:20px;z-index:999">
      <a href="data:text/html;charset=utf-8,${encodeURIComponent(this._html)}" 
         download="${filename}"
         style="display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,#4f8ef7,#7c5cfa);color:#fff;text-decoration:none;padding:12px 20px;border-radius:12px;font-family:Inter,sans-serif;font-weight:700;font-size:14px;box-shadow:0 4px 20px rgba(79,142,247,.4)">
        â¬‡ Descargar HTML
      </a>
    </div>`;
    const htmlWithBtn = this._html.replace('</body>', downloadBtn + '</body>');
    const win = window.open('', '_blank');
    if (win) {
      win.document.write(htmlWithBtn);
      win.document.close();
    } else {
      // Fallback: direct download
      const a = document.createElement('a');
      a.href = 'data:text/html;charset=utf-8,' + encodeURIComponent(this._html);
      a.download = filename;
      a.click();
    }
  },

  buildHTML(t) {
    const days = Itin.getDays(t);
    const allActs = DB.activities.filter(a => a.viaje_id === t.id);
    const moneda = t.moneda || 'EUR';
    const budget = t.presupuesto || 0;
    const totalCost = allActs.reduce((s,a) => s+(a.coste||0), 0);
    const showAmt = State.showAmounts;
    const tipoEmoji = { vuelo:'âœˆï¸', transporte:'ğŸšŒ', alojamiento:'ğŸ¨', visita:'ğŸ›ï¸', comida:'ğŸ½ï¸', compras:'ğŸ›ï¸', actividad:'ğŸ¯', otro:'ğŸ“Œ' };
    const estadoColor = { pendiente:'#f0b429', reservado:'#4f8ef7', pagado:'#10d48e', cancelado:'#7a88a8' };
    const estadoLabel = { pendiente:'â³ Pendiente', reservado:'ğŸ”µ Reservado', pagado:'âœ… Pagado', cancelado:'âŒ Cancelado' };
    const dayColors = ['#4f8ef7','#7c5cfa','#10d48e','#f0b429','#f45b7a','#38bdf8','#fb923c'];

    let totalDias = 'â€”';
    if (t.fecha_inicio && t.fecha_fin) {
      totalDias = Math.round((new Date(t.fecha_fin) - new Date(t.fecha_inicio))/864e5)+1;
    }

    const pct = budget > 0 ? Math.min(totalCost/budget*100,100).toFixed(1) : 0;
    const avail = budget - totalCost;

    const dayRows = days.map((d, i) => {
      const acts = DB.activities.filter(a => a.viaje_id === t.id && a.fecha === d)
        .sort((a,b) => (a.hora_inicio||'').localeCompare(b.hora_inicio||''));
      if (acts.length === 0) return '';
      const dt = new Date(d + 'T12:00:00').toLocaleDateString('es-ES', { weekday:'long', day:'numeric', month:'long' });
      const dayCost = acts.reduce((s,a) => s+(a.coste||0), 0);
      const color = dayColors[i % dayColors.length];
      const dayLabel = t.dayLabels && t.dayLabels[d] ? ' &middot; ' + t.dayLabels[d] : '';

      const actRows = acts.map(a => `
        <div style="display:flex;gap:14px;padding:12px 16px;border-bottom:1px solid #1d2640;align-items:flex-start">
          <div style="font-size:22px;line-height:1;padding-top:2px;width:28px;text-align:center;flex-shrink:0">${tipoEmoji[a.tipo]||'ğŸ“Œ'}</div>
          <div style="flex:1;min-width:0">
            <div style="font-size:14px;font-weight:700;color:#e8edf8;margin-bottom:4px">${a.titulo}</div>
            <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">
              ${a.hora_inicio ? `<span style="font-size:11px;color:#7a88a8">â° ${a.hora_inicio}${a.hora_fin?' â†’ '+a.hora_fin:''}</span>` : ''}
              ${a.lugar ? `<span style="font-size:11px;color:#7a88a8">ğŸ“ ${a.lugar}</span>` : ''}
              ${a.referencia ? `<span style="font-size:11px;color:#7a88a8">ğŸ”– ${a.referencia}</span>` : ''}
            </div>
            ${a.notas ? `<div style="font-size:11px;color:#3d4d68;font-style:italic;margin-top:5px">${a.notas}</div>` : ''}
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:5px;flex-shrink:0">
            <span style="font-size:10px;font-weight:700;color:${estadoColor[a.estado]||'#7a88a8'};background:${estadoColor[a.estado]||'#7a88a8'}22;padding:3px 9px;border-radius:10px;white-space:nowrap">${estadoLabel[a.estado]||a.estado}</span>
            ${showAmt && a.coste > 0 ? `<span style="font-size:12px;color:#10d48e;font-weight:700;font-family:'Courier New',monospace">ğŸ’¶ ${fmtNum(a.coste)} ${moneda}</span>` : ''}
          </div>
        </div>`).join('');

      return `
      <div style="margin-bottom:20px;border-radius:14px;overflow:hidden;border:1px solid ${color}33;box-shadow:0 4px 20px ${color}11">
        <div style="background:linear-gradient(135deg,${color}25,${color}08);border-bottom:1px solid ${color}44;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
          <div style="display:flex;align-items:center;gap:12px">
            <div style="width:40px;height:40px;border-radius:50%;border:2.5px solid ${color};display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:900;color:${color};background:#080c18;flex-shrink:0">${i+1}</div>
            <div>
              <div style="font-size:17px;font-weight:800;color:${color}">DÃ­a ${i+1}${dayLabel}</div>
              <div style="font-size:11px;color:#7a88a8;margin-top:1px;text-transform:capitalize">${dt}</div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:16px">
            <span style="font-size:12px;color:#7a88a8">${acts.length} actividad${acts.length!==1?'es':''}</span>
            ${showAmt && dayCost > 0 ? `<span style="font-size:13px;color:#10d48e;font-weight:700;font-family:'Courier New',monospace">ğŸ’¶ ${fmtNum(dayCost)} ${moneda}</span>` : ''}
          </div>
        </div>
        <div style="background:#0a0f1e">${actRows}</div>
      </div>`;
    }).join('');

    const budgetBar = showAmt && budget > 0 ? `
      <div style="background:#0f1524;border:1px solid #1d2640;border-radius:12px;padding:18px 22px;margin-bottom:20px">
        <div style="font-size:13px;font-weight:700;color:#7a88a8;letter-spacing:1px;text-transform:uppercase;margin-bottom:14px">ğŸ’° Resumen econÃ³mico</div>
        <div style="display:flex;justify-content:space-between;margin-bottom:8px">
          <span style="font-size:13px;color:#7a88a8">Presupuesto total</span>
          <span style="font-size:13px;font-weight:700;color:#f0b429;font-family:'Courier New',monospace">${fmtNum(budget)} ${moneda}</span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:8px">
          <span style="font-size:13px;color:#7a88a8">Gasto estimado</span>
          <span style="font-size:13px;font-weight:700;color:#e8edf8;font-family:'Courier New',monospace">${fmtNum(totalCost)} ${moneda}</span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:14px">
          <span style="font-size:13px;color:#7a88a8">${avail >= 0 ? 'Disponible' : 'Exceso'}</span>
          <span style="font-size:13px;font-weight:700;color:${avail>=0?'#10d48e':'#f45b7a'};font-family:'Courier New',monospace">${fmtNum(Math.abs(avail))} ${moneda}</span>
        </div>
        <div style="height:6px;background:#1d2640;border-radius:3px;overflow:hidden">
          <div style="height:100%;width:${pct}%;background:${pct>90?'#f45b7a':pct>70?'#f0b429':'#4f8ef7'};border-radius:3px"></div>
        </div>
        <div style="font-size:11px;color:#3d4d68;margin-top:6px;text-align:right">${pct}% del presupuesto</div>
      </div>` : '';

    return `<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>âœˆ ${t.nombre} â€” Aventura360</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:#080c18;font-family:'Inter',sans-serif;color:#e8edf8;padding:24px;min-height:100vh}
  @media(max-width:600px){body{padding:12px}}
</style>
</head>
<body>
<div style="max-width:680px;margin:0 auto">

  <!-- Logo header -->
  <div style="text-align:center;margin-bottom:24px;padding:6px 0">
    <span style="font-size:13px;font-weight:700;letter-spacing:3px;color:#3d4d68;text-transform:uppercase">âœˆ AVENTURA360 &nbsp;Â·&nbsp; Planificador de Viajes</span>
  </div>

  <!-- Tarjeta principal del viaje -->
  <div style="background:#0f1524;border:1px solid #1d2640;border-radius:16px;padding:24px 28px;margin-bottom:24px;position:relative;overflow:hidden">
    <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#4f8ef7,#7c5cfa,#f45b7a)"></div>
    <div style="font-size:24px;font-weight:900;color:#e8edf8;margin-bottom:8px">${t.nombre}</div>
    <div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px">
      ${t.destino ? `<span style="font-size:13px;color:#7a88a8">ğŸ“ ${t.destino}</span>` : ''}
      ${t.fecha_inicio ? `<span style="font-size:13px;color:#7a88a8">ğŸ“… ${t.fecha_inicio} â†’ ${t.fecha_fin}</span>` : ''}
      ${t.notas ? `<span style="font-size:13px;color:#7a88a8;font-style:italic">${t.notas}</span>` : ''}
    </div>
    <div style="display:flex;gap:0;background:#080c18;border-radius:10px;overflow:hidden;border:1px solid #1d2640">
      <div style="flex:1;text-align:center;padding:14px 8px;border-right:1px solid #1d2640">
        <div style="font-size:30px;font-weight:900;color:#4f8ef7;font-family:'Courier New',monospace;line-height:1">${totalDias}</div>
        <div style="font-size:9px;font-weight:700;letter-spacing:1.5px;color:#3d4d68;margin-top:4px;text-transform:uppercase">DÃ­as</div>
      </div>
      <div style="flex:1;text-align:center;padding:14px 8px;border-right:1px solid #1d2640">
        <div style="font-size:30px;font-weight:900;color:#10d48e;font-family:'Courier New',monospace;line-height:1">${allActs.length}</div>
        <div style="font-size:9px;font-weight:700;letter-spacing:1.5px;color:#3d4d68;margin-top:4px;text-transform:uppercase">Actividades</div>
      </div>
      ${showAmt && budget > 0 ? `
      <div style="flex:1;text-align:center;padding:14px 8px">
        <div style="font-size:30px;font-weight:900;color:#f0b429;font-family:'Courier New',monospace;line-height:1">${fmtNum(budget)}</div>
        <div style="font-size:9px;font-weight:700;letter-spacing:1.5px;color:#3d4d68;margin-top:4px;text-transform:uppercase">${moneda}</div>
      </div>` : ''}
    </div>
  </div>

  <!-- Bloque presupuesto -->
  ${budgetBar}

  <!-- Itinerario por dÃ­as -->
  <div style="font-size:13px;font-weight:700;color:#7a88a8;letter-spacing:1px;text-transform:uppercase;margin-bottom:14px">ğŸ—“ Itinerario</div>
  ${dayRows}

  <!-- Footer -->
  <div style="text-align:center;padding:20px 0 8px;border-top:1px solid #1d2640;margin-top:8px">
    <div style="font-size:11px;color:#3d4d68">Generado con <strong style="color:#4f8ef7">âœˆ AVENTURA360</strong> &nbsp;Â·&nbsp; Planificador de Viajes</div>
  </div>

</div>
</body>
</html>`;
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Rates = {
  async fetch() {
    try {
      const r = await fetch('https://api.exchangerate-api.com/v4/latest/EUR');
      if (r.ok) {
        const d = await r.json();
        Object.assign(State.rates, d.rates);
        const keys = Object.keys(State.rates).slice(0, 4).join(', ');
        document.getElementById('rateInfo').textContent = 'Tasas actualizadas Â· ' + new Date().toLocaleDateString('es-ES');
        App.render();
      }
    } catch(e) {
      document.getElementById('rateInfo').textContent = 'Tasas estimadas (sin conexiÃ³n)';
    }
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEMO DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Demo = {
  load() {
    DB.trips = [
      { id:'TD1', nombre:'JapÃ³n Primavera 2026', destino:'Tokio Â· Kioto Â· Osaka',
        fecha_inicio:'2026-04-01', fecha_fin:'2026-04-15', presupuesto:4500,
        moneda:'EUR', notas:'Viaje de 15 dÃ­as por JapÃ³n',
        pres_vuelos:1200, pres_hoteles:1500, pres_transfers:200,
        pres_excursiones:600, pres_comidas:500, pres_seguros:150 },
      { id:'TD2', nombre:'Lisboa Weekend', destino:'Lisboa, Portugal',
        fecha_inicio:'2026-06-20', fecha_fin:'2026-06-23', presupuesto:800,
        moneda:'EUR', notas:'Escapada de fin de semana',
        pres_vuelos:200, pres_hoteles:300, pres_transfers:60,
        pres_excursiones:100, pres_comidas:120, pres_seguros:30 },
    ];
    DB.expenses = [
      { id:'GD1', viaje_id:'TD1', descripcion:'Vuelo BCNâ†’NRT Iberia/JAL', categoria:'vuelos', estado:'pagado', importe:980, moneda:'EUR', importe_base:980, fecha:'2026-02-10', proveedor:'Iberia', referencia:'IB7742', notas:'Directo' },
      { id:'GD2', viaje_id:'TD1', descripcion:'Hotel Shinjuku Granbell 7 noches', categoria:'hoteles', estado:'reservado', importe:1200, moneda:'EUR', importe_base:1200, fecha:'2026-04-01', proveedor:'Booking.com', referencia:'BK-99821' },
      { id:'GD3', viaje_id:'TD1', descripcion:'JR Pass 14 dÃ­as', categoria:'transfers', estado:'pagado', importe:45000, moneda:'JPY', importe_base:280, fecha:'2026-03-15', proveedor:'JR Pass' },
      { id:'GD4', viaje_id:'TD1', descripcion:'ExcursiÃ³n Monte Fuji', categoria:'excursiones', estado:'pendiente', importe:120, moneda:'EUR', importe_base:120, fecha:'2026-04-05', proveedor:'Viator' },
      { id:'GD5', viaje_id:'TD1', descripcion:'Seguro viaje AXA', categoria:'seguros', estado:'pagado', importe:89, moneda:'EUR', importe_base:89, fecha:'2026-02-20', proveedor:'AXA' },
      { id:'GD6', viaje_id:'TD1', descripcion:'Cenas Tokio (estimado)', categoria:'comidas', estado:'pendiente', importe:300, moneda:'EUR', importe_base:300, fecha:'2026-04-03' },
      { id:'GD7', viaje_id:'TD1', descripcion:'Tokyo DisneySea', categoria:'excursiones', estado:'reservado', importe:9800, moneda:'JPY', importe_base:60, fecha:'2026-04-08', proveedor:'Disney' },
      { id:'GD8', viaje_id:'TD1', descripcion:'Transfer Naritaâ†’Hotel', categoria:'transfers', estado:'pendiente', importe:30, moneda:'EUR', importe_base:30, fecha:'2026-04-01' },
      { id:'GD9',  viaje_id:'TD2', descripcion:'Vuelo BCNâ†’LIS Vueling', categoria:'vuelos', estado:'pagado', importe:145, moneda:'EUR', importe_base:145, fecha:'2026-05-01', proveedor:'Vueling', referencia:'VY8123' },
      { id:'GD10', viaje_id:'TD2', descripcion:'Hotel Bairro Alto', categoria:'hoteles', estado:'pagado', importe:290, moneda:'EUR', importe_base:290, fecha:'2026-06-20', proveedor:'HBA' },
      { id:'GD11', viaje_id:'TD2', descripcion:'Pasteles de BelÃ©m + cafÃ©s', categoria:'comidas', estado:'pagado', importe:45, moneda:'EUR', importe_base:45, fecha:'2026-06-21' },
      { id:'GD12', viaje_id:'TD2', descripcion:'Tour Sintra dÃ­a completo', categoria:'excursiones', estado:'pendiente', importe:65, moneda:'EUR', importe_base:65, fecha:'2026-06-22' },
    ];
    DB.activities = [
      { id:'AD1', viaje_id:'TD1', fecha:'2026-04-01', titulo:'Vuelo BCN â†’ Narita', tipo:'vuelo', estado:'confirmado', hora_inicio:'10:30', hora_fin:'06:00', lugar:'Aeropuerto El Prat T1', coste:980, referencia:'IB7742', url:'', notas:'Escala Madrid. Llegada +1 dÃ­a.' },
      { id:'AD2', viaje_id:'TD1', fecha:'2026-04-01', titulo:'Transfer Narita â†’ Hotel Shinjuku', tipo:'transporte', estado:'confirmado', hora_inicio:'07:30', hora_fin:'09:30', lugar:'Narita Express', coste:30, referencia:'', url:'', notas:"Tren N'EX directo, 90 min." },
      { id:'AD3', viaje_id:'TD1', fecha:'2026-04-01', titulo:'Check-in Hotel Shinjuku Granbell', tipo:'alojamiento', estado:'confirmado', hora_inicio:'15:00', hora_fin:'', lugar:'Shinjuku, Tokio', coste:0, referencia:'BK-99821', url:'https://www.granbellhotel.jp', notas:'Check-in desde 15h.' },
      { id:'AD4', viaje_id:'TD1', fecha:'2026-04-01', titulo:'Paseo por Shinjuku', tipo:'visita', estado:'pendiente', hora_inicio:'17:00', hora_fin:'20:00', lugar:'Shinjuku, Tokio', coste:0, referencia:'', url:'', notas:'Explorar Golden Gai.' },
      { id:'AD5', viaje_id:'TD1', fecha:'2026-04-01', titulo:'Cena Ramen Ichiran', tipo:'comida', estado:'pendiente', hora_inicio:'20:30', hora_fin:'22:00', lugar:'Ichiran Shinjuku', coste:15, referencia:'', url:'https://ichiran.com', notas:'' },
      { id:'AD6', viaje_id:'TD1', fecha:'2026-04-02', titulo:'Templo Senso-ji + Nakamise', tipo:'visita', estado:'pendiente', hora_inicio:'09:30', hora_fin:'12:00', lugar:'Asakusa, Tokio', coste:0, referencia:'', url:'https://www.senso-ji.jp', notas:'Entrada gratuita.' },
      { id:'AD7', viaje_id:'TD1', fecha:'2026-04-02', titulo:'Almuerzo sushi Tsukiji', tipo:'comida', estado:'pendiente', hora_inicio:'13:00', hora_fin:'14:00', lugar:'Mercado exterior Tsukiji', coste:30, referencia:'', url:'', notas:'' },
      { id:'AD8', viaje_id:'TD1', fecha:'2026-04-02', titulo:'Akihabara electrÃ³nica', tipo:'compras', estado:'pendiente', hora_inicio:'16:00', hora_fin:'19:00', lugar:'Akihabara, Tokio', coste:100, referencia:'', url:'', notas:'Presupuesto regalos/gadgets.' },
      { id:'AD9', viaje_id:'TD1', fecha:'2026-04-03', titulo:'ExcursiÃ³n Monte Fuji (tour)', tipo:'actividad', estado:'confirmado', hora_inicio:'07:00', hora_fin:'19:00', lugar:'Monte Fuji, Shizuoka', coste:120, referencia:'VTR-88221', url:'https://viator.com', notas:'Salida bus desde Shinjuku.' },
      { id:'AD10', viaje_id:'TD2', fecha:'2026-06-20', titulo:'Vuelo BCN â†’ Lisboa', tipo:'vuelo', estado:'completado', hora_inicio:'07:15', hora_fin:'09:20', lugar:'Aeropuerto El Prat T2', coste:145, referencia:'VY8123', url:'', notas:'' },
      { id:'AD11', viaje_id:'TD2', fecha:'2026-06-20', titulo:'Paseo por Alfama', tipo:'visita', estado:'pendiente', hora_inicio:'16:00', hora_fin:'19:30', lugar:'Alfama, Lisboa', coste:0, referencia:'', url:'', notas:'Barrio histÃ³rico.' },
      { id:'AD12', viaje_id:'TD2', fecha:'2026-06-20', titulo:'Cena con Fado en vivo', tipo:'comida', estado:'pendiente', hora_inicio:'20:30', hora_fin:'23:00', lugar:'Tasca do Chico', coste:45, referencia:'', url:'https://tascadochico.pt', notas:'Reserva necesaria.' },
      { id:'AD13', viaje_id:'TD2', fecha:'2026-06-21', titulo:'PastÃ©is de BelÃ©m', tipo:'comida', estado:'pendiente', hora_inicio:'09:00', hora_fin:'09:45', lugar:'PastÃ©is de BelÃ©m', coste:8, referencia:'', url:'', notas:'' },
      { id:'AD14', viaje_id:'TD2', fecha:'2026-06-22', titulo:'Tour Sintra dÃ­a completo', tipo:'actividad', estado:'pendiente', hora_inicio:'09:00', hora_fin:'18:00', lugar:'Sintra, Portugal', coste:65, referencia:'', url:'https://viator.com', notas:'Palacio da Pena + Quinta da Regaleira.' },
    ];
    State.tripId = 'TD1';
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLOSE MODALS ON BACKDROP CLICK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.overlay').forEach(o => {
  o.addEventListener('click', e => {
    if (e.target === o && o.id !== 'dlgConfirm') App.closeModal(o.id);
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
App.init();
</script>
</body>
</html>
